<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tangent SFF RPG Persona Folio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js" xintegrity="sha512-w61kvDEdEh9PzJIZhJ4MVIy/MJoCHucfbzH2K8MAoYAiA93gs/o2yBDR8AstsTUr86gNIlr4FwyG3DRL32S+zA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js" xintegrity="sha512-nNkHPz+lD0Wf0eF_HsscpfrAYuEtF96SQXo2iQDrBCGucwKNYf9A1wL4hZPAy2oUv41NS1QeRbeBC5lAa3T7Jw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* style.css content is now embedded in the HTML file for simplicity */
        :root {
            /* New darker greyscale palette for high contrast */
            --bg-color: #212121; /* Dark page background */
            --section-bg: #424242; /* Lighter grey for sections */
            --text-color: #f5f5f5; /* Light grey text */
            --border-color: #9e9e9e; /* Lighter grey for borders */
            --subtle-border: #616161; /* Darker grey for internal lines */
            --header-bg: #333333; 
            --header-text: #eeeeee; 
            --input-bg: #616161; /* Mid-grey for inputs */
            --input-text: #ffffff;
            --font-body: 'Roboto Condensed', sans-serif; 
            --font-display: 'Roboto', sans-serif;
            --spacing-xs: 0.25rem; --spacing-sm: 0.5rem; --spacing-md: 1rem; --spacing-lg: 1.5rem;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: var(--spacing-md); 
        }
        .character-sheet { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-lg); 
        }
        .main-section { 
            border: 2px solid var(--border-color); 
            padding: var(--spacing-lg); 
            background-color: var(--section-bg); 
            border-radius: 8px;
        }
        .sheet-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center; 
            font-family: var(--font-display); 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: var(--spacing-lg); 
            padding-bottom: var(--spacing-md); 
        }
        .sheet-header h1 { margin: 0; color: var(--text-color); flex-grow: 1; text-align: center; }
        .actor-display {
            width: 200px; /* Give it space */
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 50px; /* Ensure consistent height */
        }
        #actor-display-header {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
        }
        #actor-display-header .uid-display {
            font-size: 0.6em;
            font-weight: normal;
            word-break: break-all;
            color: var(--border-color);
            line-height: 1.2;
        }

        .creator-credit {
            text-align: center;
            margin-top: var(--spacing-lg);
            font-size: 0.8rem;
            color: var(--header-text);
            font-family: var(--font-display);
            letter-spacing: 2px;
        }
        /* File Menu Styles */
        .file-menu { position: relative; width: 100px; /* Give it a fixed width */ }
        .file-menu-button {
            font-family: var(--font-body); 
            font-weight: bold; 
            font-size: 0.9rem; 
            padding: 0.75rem var(--spacing-md); 
            border: 2px solid var(--header-text); 
            border-radius: 5px;
            background-color: var(--header-bg); 
            color: #ffffff; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; 
            text-shadow: 1px 1px 2px #000;
        }
        .file-menu-button:hover {
            background-color: #eeeeee; 
            color: #212121;
            border-color: #eeeeee; 
            text-shadow: none;
        }
        .file-menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 5px;
            padding: var(--spacing-sm);
            z-index: 100;
            min-width: 200px;
        }
        .file-menu-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: var(--spacing-sm);
            background-color: var(--input-bg);
            color: var(--input-text);
            border-radius: 3px;
            border: none;
            padding: var(--spacing-sm);
            cursor: pointer;
        }
        .file-menu-dropdown button:hover:not(:disabled) {
            filter: brightness(1.2);
        }
        .file-menu-dropdown button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .file-menu-dropdown button:last-child { margin-bottom: 0; }
        .file-menu-dropdown.show { display: block; }
        #load-json-input { display: none; }

        .columns-2 { display: flex; gap: var(--spacing-lg); }
        .columns-2.equal-width > * {
            flex: 1;
        }
        fieldset { 
            border: 2px solid var(--border-color); 
            border-radius: 4px;
            padding: var(--spacing-md); 
            margin: 0 0 var(--spacing-lg) 0; 
        }
        fieldset:last-child { margin-bottom: 0; }
        legend { 
            font-weight: bold; 
            padding: 0 var(--spacing-sm); 
            font-family: var(--font-display); 
            text-transform: uppercase; 
        }
        .input-group { display: flex; flex-direction: column; }
        .input-group.full-width { grid-column: 1 / -1; }
        label { margin-bottom: var(--spacing-xs); font-size: 0.875rem; font-weight: bold; color: var(--header-text); }
        input[type="text"], input[type="number"], input[type="email"], input[type="password"], select, textarea { 
            width: 100%; 
            padding: var(--spacing-sm); 
            border: 1.5px solid var(--border-color); 
            border-radius: 4px;
            background-color: var(--input-bg); 
            color: var(--input-text);
            font-family: var(--font-body); 
            font-size: 1rem; 
        }
        textarea { resize: vertical; }

        /* Grid Layouts */
        .bio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md) var(--spacing-lg);
        }
        .vitals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md); }
        .attributes-container { display: flex; gap: var(--spacing-md); }
        .attribute-column { flex: 1; display: flex; flex-direction: column; gap: var(--spacing-md); }
        .attribute-group { display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto; gap: 0 var(--spacing-sm); align-items: center; }
        
        .attribute-group label:nth-of-type(1) { 
            grid-column: 1; 
            grid-row: 1; 
            font-size: 1.05rem;
            font-weight: bold; /* Make primary attribute labels bold */
        }
        .attribute-group input {
            text-align: center; /* Center text in all attribute inputs */
        }
        .attribute-group input:nth-of-type(1) { grid-column: 2; grid-row: 1; width: 60px; }
        .attribute-group label:nth-of-type(2) { 
            grid-column: 1; 
            grid-row: 2; 
            font-size: 0.8rem; 
            padding-left: var(--spacing-md);
            font-style: italic;
        }
        .attribute-group input:nth-of-type(2) { grid-column: 2; grid-row: 2; width: 60px; }
        
        .attack-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 3fr; gap: var(--spacing-sm); align-items: center; }
        .armor-grid { display: grid; grid-template-columns: 1fr 1fr 4fr; gap: var(--spacing-sm) var(--spacing-md); align-items: center; }
        .armor-grid label { font-weight: bold; margin-bottom: 0; }
        .attack-header, .armor-header, .grid-header { font-weight: bold; font-size: 0.8rem; color: var(--header-text); border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); }

        .core-stats-container { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .ratings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
        .move-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-md); }
        .perception-grid { display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-xs) var(--spacing-sm); align-items: center;}
        .perception-grid > input:first-child { grid-column: 1 / -1; margin-bottom: var(--spacing-sm); }
        .perception-grid label { text-align: right; }

        /* Skills Section */
        .skills-column {
             display: flex;
             flex-direction: column;
             gap: var(--spacing-lg);
        }
        .skill-group { break-inside: avoid; }
        .skill-group-header { background-color: var(--header-bg); padding: var(--spacing-sm); margin: 0 0 var(--spacing-sm) 0; text-align: center; font-family: var(--font-display); text-transform: uppercase; border: 1.5px solid var(--subtle-border);}
        .skill-subcategory-header {
            font-family: var(--font-body);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            color: var(--header-text);
            padding-left: var(--spacing-sm);
            margin: var(--spacing-md) 0 var(--spacing-sm) 0;
            border-bottom: 1.5px solid var(--subtle-border);
        }
        .skill-row { display: grid; grid-template-columns: 2.5fr 1fr 1.5fr 1fr 1fr; gap: var(--spacing-sm); align-items: center; margin-bottom: var(--spacing-sm); }
        .skill-row.header { font-weight: bold; text-align: center; font-size: 0.8rem; color: var(--header-text); }
        .skill-row.header span { border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); }
        .skill-row label { font-weight: normal; margin-bottom: 0; color: var(--text-color); }
        .skill-row input, .skill-row select { text-align: center; padding: var(--spacing-xs); font-size: 0.9rem; }
        .skill-row input.skill-name-input {
            text-align: left;
            font-style: italic;
        }
        .skill-row .skill-total { background-color: var(--header-bg); font-weight: bold; }

        /* Folio 2 & 3 Specifics */
        .trait-grid { display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-sm) var(--spacing-md); }
        .trait-grid-container { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .trait-grid h5 { margin: 0; grid-column: 1 / -1; font-family: var(--font-display); text-transform: uppercase; border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); margin-bottom: var(--spacing-sm); }
        .trait-grid .grid-header { font-weight: bold; font-size: 0.8rem; color: var(--header-text); }
        .simple-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .single-column-grid { display: grid; grid-template-columns: 1fr; gap: var(--spacing-sm); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--section-bg); padding: var(--spacing-lg);
            border-radius: 8px; border: 2px solid var(--border-color);
            width: 90%; max-width: 500px; text-align: center;
        }
        .modal-content p { margin-top: 0; margin-bottom: var(--spacing-md); }
        .modal-content .modal-error { color: #f87171; font-size: 0.9rem; margin-top: var(--spacing-sm); height: 1.2rem; }
        .modal-auth-form { display: flex; flex-direction: column; gap: var(--spacing-sm); }
        .modal-buttons { display: flex; justify-content: center; gap: var(--spacing-md); flex-wrap: wrap; margin-top: var(--spacing-md);}
        .modal-buttons button {
             font-family: var(--font-body); font-weight: bold;
             padding: var(--spacing-sm) var(--spacing-md); border: 2px solid var(--header-text);
             border-radius: 5px; background-color: var(--header-bg); color: #ffffff; cursor: pointer;
        }
        .modal-buttons button:hover{ filter: brightness(1.2); }
        .modal-choices { display: flex; flex-direction: column; gap: var(--spacing-sm); max-height: 200px; overflow-y: auto; margin-top: var(--spacing-md); }

        /* Responsive */
        @media (max-width: 768px) {
            .columns-2 { flex-direction: column; }
            .bio-grid { grid-template-columns: 1fr; }
            .vitals-grid, .ratings-grid, .move-grid { grid-template-columns: 1fr 1fr; }
            .attributes-container { flex-direction: column; }
            .skills-column { gap: 0; }
        }
    </style>
</head>
<body>

    <form class="character-sheet" onsubmit="return false;">
        <header class="sheet-header">
            <div id="actor-display-header" class="actor-display">Loading...</div>
            <h1>Tangent SFF RPG Persona Folio</h1>
             <div class="file-menu">
                <button type="button" class="file-menu-button">File</button>
                <div class="file-menu-dropdown">
                    <button type="button" id="logout-btn" disabled>Logout</button>
                    <hr>
                    <button type="button" id="cloud-save-btn" disabled>Save to Cloud</button>
                    <button type="button" id="cloud-load-btn" disabled>Load from Cloud</button>
                    <button type="button" id="share-btn" disabled>Share</button>
                    <hr>
                    <button type="button" id="save-json-btn">Save Local</button>
                    <button type="button" id="load-json-btn">Load Local</button>
                    <input type="file" id="load-json-input" accept=".json">
                    <hr>
                    <button type="button" id="save-pdf-btn">Print PDF</button>
                    <button type="button" id="save-md-btn">Print Markdown</button>
                </div>
            </div>
        </header>
        
        <section class="main-section" id="bio-section">
            <fieldset><legend>Character Information</legend>
                <div class="bio-grid">
                    <div class="input-group"><label for="char-name">Name</label><input type="text" id="char-name" name="char-name"></div>
                    <div class="input-group"><label for="char-concept">Concept</label><input type="text" id="char-concept" name="char-concept"></div>
                    <div class="input-group"><label for="char-species">Species</label><input type="text" id="char-species" name="char-species"></div>
                    <div class="input-group"><label for="char-occu">Occupation</label><input type="text" id="char-occu" name="char-occu"></div>
                    <div class="input-group"><label for="char-origin">Origin</label><input type="text" id="char-origin" name="char-origin"></div>
                    <div class="input-group"><label for="char-faction">Faction</label><input type="text" id="char-faction" name="char-faction"></div>
                    <div class="input-group"><label for="char-age">Age</label><input type="text" id="char-age" name="char-age"></div>
                    <div class="input-group"><label for="char-gender">Gender</label><input type="text" id="char-gender" name="char-gender"></div>
                    <div class="input-group"><label for="char-height">Height</label><input type="text" id="char-height" name="char-height"></div>
                    <div class="input-group"><label for="char-weight">Weight</label><input type="text" id="char-weight" name="char-weight"></div>
                    <div class="input-group full-width"><label for="char-style">Description / Style</label><textarea id="char-style" name="char-style" rows="2"></textarea></div>
                    <div class="input-group full-width"><label for="char-motive">Personality / Motive</label><textarea id="char-motive" name="char-motive" rows="2"></textarea></div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="attributes-stats-section">
             <div class="columns-2 equal-width">
                <div class="col-left">
                    <fieldset><legend>ATTRIBUTES</legend>
                        <div class="attributes-container">
                            <div class="attribute-column">
                                <div class="attribute-group"><label for="attr-strength">Strength</label><input type="number" id="attr-strength" class="attribute-input"><label for="attr-might">Might</label><input type="number" id="attr-might"></div>
                                <div class="attribute-group"><label for="attr-agility">Agility</label><input type="number" id="attr-agility" class="attribute-input"><label for="attr-reflex">Reflex</label><input type="number" id="attr-reflex"></div>
                                <div class="attribute-group"><label for="attr-constitution">Constitution</label><input type="number" id="attr-constitution" class="attribute-input"><label for="attr-fortitude">Fortitude</label><input type="number" id="attr-fortitude"></div>
                            </div>
                            <div class="attribute-column">
                                <div class="attribute-group"><label for="attr-intellect">Intellect</label><input type="number" id="attr-intellect" class="attribute-input"><label for="attr-logic">Logic</label><input type="number" id="attr-logic"></div>
                                <div class="attribute-group"><label for="attr-wisdom">Wisdom</label><input type="number" id="attr-wisdom" class="attribute-input"><label for="attr-will">Will</label><input type="number" id="attr-will"></div>
                                <div class="attribute-group"><label for="attr-charisma">Charisma</label><input type="number" id="attr-charisma" class="attribute-input"><label for="attr-etiquette">Etiquette</label><input type="number" id="attr-etiquette"></div>
                            </div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Modifiers</legend>
                        <div class="single-column-grid" id="modifiers-list">
                            <!-- Modifiers will be dynamically populated -->
                        </div>
                    </fieldset>
                </div>
                <div class="col-right">
                    <fieldset><legend>Core Stats</legend>
                        <div class="vitals-grid">
                            <div class="input-group"><label for="health">Health</label><input type="number" id="health"></div>
                            <div class="input-group"><label for="vitality">Vitality</label><input type="number" id="vitality"></div>
                            <div class="input-group"><label for="initiative">Initiative</label><input type="number" id="initiative"></div>
                        </div>
                    </fieldset>
                    <fieldset><legend>Ratings</legend>
                        <div class="ratings-grid">
                            <div class="input-group"><label for="karma">Karma</label><input type="number" id="karma"></div>
                            <div class="input-group"><label for="plot-points">Plot Points</label><input type="number" id="plot-points"></div>
                            <div class="input-group"><label for="tech-level">Tech Level</label><input type="text" id="tech-level"></div>
                            <div class="input-group"><label for="wealth">Wealth</label><input type="text" id="wealth"></div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Move</legend>
                        <div class="move-grid">
                            <div class="input-group"><label for="move-walk">Walk</label><input type="text" id="move-walk"></div>
                            <div class="input-group"><label for="move-swim">Swim</label><input type="text" id="move-swim"></div>
                            <div class="input-group"><label for="move-climb">Climb</label><input type="text" id="move-climb"></div>
                            <div class="input-group"><label for="move-fly">Fly</label><input type="text" id="move-fly"></div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Perception</legend>
                        <div class="perception-grid">
                            <input type="number" id="perception">
                            <label for="perception-meta">Meta</label><input type="number" id="perception-meta">
                            <label for="perception-social">Social</label><input type="number" id="perception-social">
                            <label for="perception-tech">Technology</label><input type="number" id="perception-tech">
                        </div>
                    </fieldset>
                </div>
            </div>
        </section>

        <section class="main-section" id="skills-section">
            <fieldset><legend>Skills</legend>
                <div class="columns-2 equal-width">
                    <div id="skills-list-left" class="skills-column">
                        <!-- Mental skills will be dynamically populated by JavaScript -->
                    </div>
                    <div id="skills-list-right" class="skills-column">
                        <!-- Other skills will be dynamically populated by JavaScript -->
                    </div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="combat-section">
             <fieldset><legend>Attack</legend>
                <div class="attack-grid" id="attack-rows">
                    <div class="attack-header">Attack</div><div class="attack-header">Score</div><div class="attack-header">Damage</div><div class="attack-header">Notes</div>
                    <!-- Attack rows will be populated by JS -->
                </div>
            </fieldset>
            
            <fieldset><legend>Armor Location</legend>
                <div class="armor-grid" id="armor-rows">
                    <div class="armor-header">Location</div><div class="armor-header">Total DR</div><div class="armor-header">Notes</div>
                    <label for="armor-head">Head</label><input type="text" id="armor-head-dr"><input type="text" id="armor-head-notes">
                    <label for="armor-torso">Torso</label><input type="text" id="armor-torso-dr"><input type="text" id="armor-torso-notes">
                    <label for="armor-right-arm">Right Arm</label><input type="text" id="armor-right-arm-dr"><input type="text" id="armor-right-arm-notes">
                    <label for="armor-left-arm">Left Arm</label><input type="text" id="armor-left-arm-dr"><input type="text" id="armor-left-arm-notes">
                    <label for="armor-right-leg">Right Leg</label><input type="text" id="armor-right-leg-dr"><input type="text" id="armor-right-leg-notes">
                    <label for="armor-left-leg">Left Leg</label><input type="text" id="armor-left-leg-dr"><input type="text" id="armor-left-leg-notes">
                </div>
            </fieldset>
        </section>
        
        <section class="main-section" id="folio-2">
            <fieldset><legend>Traits</legend>
                <div class="columns-2 equal-width">
                    <div id="traits-list-left" class="trait-grid-container"></div>
                    <div id="traits-list-right" class="trait-grid-container"></div>
                </div>
            </fieldset>
        </section>
        
        <section class="main-section" id="features-and-traits-section">
             <fieldset><legend>Features</legend>
                <div class="simple-grid" id="features-list">
                    <div class="grid-header">Feature</div><div class="grid-header">Effect</div>
                    <!-- Feature rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Disadvantages</legend>
                <div class="single-column-grid" id="disadvantages-list">
                    <!-- Disadvantage rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Augmentations</legend>
                <div class="simple-grid" id="augmentations-list">
                    <div class="grid-header">Augmentation</div><div class="grid-header">Effect</div>
                    <!-- Augmentation rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Other Traits</legend>
                <div class="single-column-grid" id="other-traits-list">
                    <!-- Dynamic rows -->
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="metafocus-section">
            <fieldset><legend>Metafocus</legend>
                 <div class="skill-group" id="metafocus-skills-list">
                     <!-- Metafocus skills will be populated here -->
                 </div>
                 <hr>
                 <h5 class="skill-subcategory-header" style="text-align:center; margin-top: 1rem;">Invocations</h5>
                 <div class="simple-grid" id="invocations-list">
                      <div class="grid-header">Invocation</div><div class="grid-header">Level</div>
                 </div>
                 <hr>
                 <h5 class="skill-subcategory-header" style="text-align:center; margin-top: 1rem;">Special Abilities</h5>
                 <div id="special-abilities-list">
                 </div>
            </fieldset>
        </section>

        <section class="main-section" id="folio-3">
             <fieldset><legend>Gear</legend>
                <div class="single-column-grid" id="gear-list">
                     <div class="grid-header">Gear</div>
                </div>
            </fieldset>
            <fieldset><legend>Mecha</legend>
                <div class="single-column-grid" id="mecha-list">
                     <div class="grid-header">Mecha</div>
                </div>
            </fieldset>
            <fieldset><legend>Miscellaneous</legend>
                 <div class="single-column-grid" id="miscellaneous-list">
                     <div class="grid-header">Item</div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="folio-4">
             <fieldset><legend>Notes</legend>
                <div class="single-column-grid" id="notes-list">
                    <!-- Notes rows will be populated -->
                </div>
            </fieldset>
        </section>

    </form>
    
    <footer class="creator-credit">
        WOLFE.BT@TANGENTLLC
    </footer>

    <!-- Modal for notifications and prompts -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-text"></p>
            <div id="modal-auth-form" class="modal-auth-form" style="display: none;">
                <input type="email" id="modal-email" placeholder="Email">
                <input type="password" id="modal-password" placeholder="Password">
                <div class="modal-error" id="modal-error-text"></div>
            </div>
            <div id="modal-choices" class="modal-choices"></div>
            <input type="text" id="modal-input" style="display: none;">
            <div class="modal-buttons">
                 <button id="modal-google-btn" style="display: none;">
                    <svg style="display: inline-block; height: 18px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    Sign in with Google
                </button>
                <button id="modal-register-btn" style="display: none;">Register</button>
                <button id="modal-login-btn" style="display: none;">Login</button>
                <button id="modal-copy-btn" style="display: none;">Copy</button>
                <button id="modal-ok-btn">OK</button>
                <button id="modal-cancel-btn" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase modules for database and authentication
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Character sheet script loaded. ðŸš€");

            // --- IMPORTANT: Firebase Configuration ---
             const firebaseConfig = {
                apiKey: "AIzaSyDg5I-5rofObhKS7cS2dz3cC5dybRKY9-Y",
                authDomain: "tangent-sff-rpg-sheets.firebaseapp.com",
                projectId: "tangent-sff-rpg-sheets",
                storageBucket: "tangent-sff-rpg-sheets.firebasestorage.app",
                messagingSenderId: "897760227296",
                appId: "1:897760227296:web:0e4ec5a85d1e153d76c585",
                measurementId: "G-VMEZ9HN80Q"
             };

            // --- UI ELEMENTS ---
            const sheet = document.querySelector('.character-sheet');
            const actorDisplayHeader = document.getElementById('actor-display-header');
            const logoutBtn = document.getElementById('logout-btn');
            const cloudSaveBtn = document.getElementById('cloud-save-btn');
            const cloudLoadBtn = document.getElementById('cloud-load-btn');
            const shareBtn = document.getElementById('share-btn');
            const fileMenuButton = document.querySelector('.file-menu-button');
            const fileMenuDropdown = document.querySelector('.file-menu-dropdown');

            // --- MODAL ---
            const modal = document.getElementById('custom-modal');
            const modalText = document.getElementById('modal-text');
            const modalAuthForm = document.getElementById('modal-auth-form');
            const modalEmailInput = document.getElementById('modal-email');
            const modalPasswordInput = document.getElementById('modal-password');
            const modalErrorText = document.getElementById('modal-error-text');
            const modalChoices = document.getElementById('modal-choices');
            const modalInput = document.getElementById('modal-input');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalCopyBtn = document.getElementById('modal-copy-btn');
            const modalRegisterBtn = document.getElementById('modal-register-btn');
            const modalLoginBtn = document.getElementById('modal-login-btn');
            const modalGoogleBtn = document.getElementById('modal-google-btn');
            let modalResolve = null;

            const showModal = (text, options = {}) => {
                 // Hide all optional elements initially
                [modalAuthForm, modalInput, modalChoices, modalCopyBtn, modalOkBtn, modalCancelBtn, modalRegisterBtn, modalLoginBtn, modalGoogleBtn].forEach(el => el.style.display = 'none');
                modalErrorText.textContent = '';
                
                modalText.textContent = text;

                if (options.auth) {
                    modalAuthForm.style.display = 'flex';
                    modalRegisterBtn.style.display = 'inline-block';
                    modalLoginBtn.style.display = 'inline-block';
                    modalGoogleBtn.style.display = 'inline-block';
                } else if (options.choices) {
                    modalChoices.style.display = 'flex';
                    options.choices.forEach(choice => {
                        const choiceBtn = document.createElement('button');
                        choiceBtn.textContent = choice.text;
                        choiceBtn.onclick = () => {
                            modal.classList.remove('show');
                            if(modalResolve) modalResolve(choice.value);
                        }
                        modalChoices.appendChild(choiceBtn);
                    });
                    modalCancelBtn.style.display = 'inline-block';
                } else if (options.prompt) {
                     modalInput.style.display = 'block';
                     modalInput.value = options.inputValue || '';
                     modalInput.placeholder = options.placeholder || '';
                     modalInput.readOnly = !!options.readOnly;
                     modalOkBtn.style.display = 'inline-block';
                     if(options.showCancel) modalCancelBtn.style.display = 'inline-block';
                     if(options.showCopy) modalCopyBtn.style.display = 'inline-block';
                } else {
                    modalOkBtn.style.display = 'inline-block';
                }

                modal.classList.add('show');
                return new Promise(resolve => { modalResolve = resolve; });
            };

            const closeModal = () => {
                modal.classList.remove('show');
            };

            modalOkBtn.addEventListener('click', () => {
                if (modalInput.style.display === 'block' && !modalInput.readOnly && !modalInput.value.trim()){
                    modalErrorText.textContent = "Input cannot be empty.";
                    return;
                }
                closeModal();
                if(modalResolve) modalResolve(modalInput.value.trim());
            });
            modalCancelBtn.addEventListener('click', () => {
                closeModal();
                if(modalResolve) modalResolve(null);
            });
            modalCopyBtn.addEventListener('click', () => {
                modalInput.select();
                document.execCommand('copy');
                modalCopyBtn.textContent = 'Copied!';
                setTimeout(() => { modalCopyBtn.textContent = 'Copy'; }, 2000);
            });

            // --- FIREBASE AND AUTHENTICATION ---
            let auth, db, appId;
            
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration is missing. Please paste your config object into the script.");
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                getAnalytics(app);
                setLogLevel('debug');
                console.log("Firebase initialized.");
                appId = firebaseConfig.appId;
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showModal(error.message);
                return; // Stop execution if Firebase fails
            }

            const getActorsCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'actors');
            const getPrivateCollection = (uid) => collection(db, 'artifacts', appId, 'users', uid, 'characterSheets');
            const getPublicCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'characterSheets');
            
            const fetchAndDisplayActorName = async (user) => {
                const uid = user.uid;
                try {
                    const actorDocRef = doc(getActorsCollection(), uid);
                    const actorDoc = await getDoc(actorDocRef);
                    if (actorDoc.exists()) {
                        actorDisplayHeader.innerHTML = `${actorDoc.data().actorName} <div class="uid-display">${user.email}</div>`;
                        [cloudSaveBtn, cloudLoadBtn, shareBtn, logoutBtn].forEach(btn => btn.disabled = false);
                        closeModal();
                    } else {
                        // First time login for this user, prompt for actor name
                        await promptAndSetActorName(user);
                    }
                } catch (error) {
                    console.error("Error fetching actor name:", error);
                    showModal("Could not fetch your profile. Please try refreshing the page.");
                }
            };

            const promptAndSetActorName = async (user) => {
                const uid = user.uid;
                let actorName = '';
                while(!actorName || actorName.trim() === "") {
                    const result = await showModal("Welcome! Please choose a public Actor Name:", { prompt: true, showCancel: false });
                    actorName = result ? result.trim() : "";
                }

                try {
                    const actorDocRef = doc(getActorsCollection(), uid);
                    await setDoc(actorDocRef, { actorName: actorName });
                    await fetchAndDisplayActorName(user);
                } catch (error) {
                    console.error("Error setting actor name: ", error);
                    showModal("Could not save your Actor Name. Please try refreshing the page.");
                }
            };
            
            modalRegisterBtn.addEventListener('click', async () => {
                const email = modalEmailInput.value;
                const password = modalPasswordInput.value;
                modalErrorText.textContent = '';
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    modalErrorText.textContent = error.message;
                }
            });

            modalLoginBtn.addEventListener('click', async () => {
                const email = modalEmailInput.value;
                const password = modalPasswordInput.value;
                modalErrorText.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                     modalErrorText.textContent = error.message;
                }
            });

            modalGoogleBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                modalErrorText.textContent = '';
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    modalErrorText.textContent = error.message;
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                signOut(auth);
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User is signed in:", user.uid);
                    fetchAndDisplayActorName(user);
                } else {
                    console.log("User is signed out.");
                    actorDisplayHeader.textContent = 'Logged Out';
                    [cloudSaveBtn, cloudLoadBtn, shareBtn, logoutBtn].forEach(btn => btn.disabled = true);
                    showModal("Welcome! Please log in or register to use cloud features.", { auth: true });
                }
            });

            // --- FILE MENU LOGIC ---
            fileMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                fileMenuDropdown.classList.toggle('show');
            });

            document.addEventListener('click', (event) => {
                if (!fileMenuButton.contains(event.target) && !fileMenuDropdown.contains(event.target)) {
                    fileMenuDropdown.classList.remove('show');
                }
            });

            // --- DATA & SETUP ---
            const attributeOptions = [
                { value: 'attr-strength', text: 'Strength' }, { value: 'attr-agility', text: 'Agility' },
                { value: 'attr-constitution', text: 'Constitution' }, { value: 'attr-intellect', text: 'Intellect' },
                { value: 'attr-wisdom', text: 'Wisdom' }, { value: 'attr-charisma', text: 'Charisma' },
            ];
            const mentalSkillData = {
                "Mental": {
                    "skills": ["Alertness"],
                    "subcategories": {
                        "Knowledge": ["Academics", "Appraisal", "Computers", "Culture", "History", "Investigation", "Language", "Medicine", "Nature", "Navigation", "Nobility", "Physics", "Religion", "Science", "Survival", "Tactics", "Technology"],
                        "Vocation": ["Administrator", "Alchemist", "Ambassador", "Architect", "Archivist", "Armorer", "Artist", "Artificer", "Broker", "Celebrity", "Constable", "Courtesan", "Culinarian", "Demolitionist", "Electrician", "Engineer", "Groundskeeper", "Handler", "Laborer", "Mechanic", "Researcher", "Salvager", "Soldier", "Tailor", "Transporter", "Weaponsmith"]
                    }
                }
            };
            const otherSkillData = {
               "Physical": { "skills": ["Acrobatics", "Athletics", "Piloting", "Stealth"] },
               "Social": {
                   "subcategories": {
                       "Manipulation": ["Insight", "Bluff", "Diplomacy", "Intimidate", "Streetwise"],
                       "Expression": ["Acting", "Comedy", "Dancing", "Disguise", "Keyboard", "Legerdemain", "Oratory", "Percussion", "Singing", "String", "Style", "Wind"]
                   }
               },
               "Combat": {
                   "subcategories": {
                       "Archaic": ["Defense", "Melee", "Ranged", "Unarmed"],
                       "Modern": ["Ballistic", "Heavy Weapons"],
                       "Advanced": ["Energy", "Heavy Energy"]
                   }
               }
            };
            const metafocusData = {
                "Attune": [], "Dimension": ["Summoning", "Teleport"],
                "Energy": ["Elemental", "Force"], "Entropy": ["Chaos", "Order"],
                "Illusion": ["Phantasmal", "Shadow"], "Matter": ["Enhancement", "Transmutation"],
                "Mental": ["Projection", "Sense"]
            };

            // --- DYNAMIC ELEMENT CREATION ---
            function createSkillRow(skillName, skillId) {
                const row = document.createElement('div');
                row.className = 'skill-row';
                row.dataset.skillId = skillId;
                let optionsHtml = '<option value="">--</option>' + attributeOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
                row.innerHTML = `
                    <label for="skill-${skillId}-rank">${skillName}</label>
                    <input type="number" id="skill-${skillId}-rank" class="skill-rank" placeholder="0">
                    <select id="skill-${skillId}-base" class="skill-base-select">${optionsHtml}</select>
                    <input type="number" id="skill-${skillId}-mod" class="skill-mod" placeholder="0">
                    <input type="number" id="skill-${skillId}-total" class="skill-total" readonly>`;
                return row;
            }

            function createEditableSkillRow(skillId) {
                const row = document.createElement('div');
                row.className = 'skill-row';
                row.dataset.skillId = skillId;
                row.dataset.dynamicRow = "true";
                let optionsHtml = '<option value="">--</option>' + attributeOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
                row.innerHTML = `
                    <input type="text" id="skill-${skillId}-name" class="skill-name-input" placeholder="Enter ability name..." data-dynamic-row="true">
                    <input type="number" id="skill-${skillId}-rank" class="skill-rank" placeholder="0" data-dynamic-row="true">
                    <select id="skill-${skillId}-base" class="skill-base-select" data-dynamic-row="true">${optionsHtml}</select>
                    <input type="number" id="skill-${skillId}-mod" class="skill-mod" placeholder="0" data-dynamic-row="true">
                    <input type="number" id="skill-${skillId}-total" class="skill-total" readonly>`;
                return row;
            }
            
            function addTraitRow(grid, traitType) {
                const index = grid.querySelectorAll('[data-dynamic-row="true"]').length / 2;
                const traitInput = document.createElement('input');
                traitInput.type = 'text';
                traitInput.id = `trait-${traitType}-trait-${index}`;
                traitInput.dataset.dynamicRow = "true";
                const effectInput = document.createElement('input');
                effectInput.type = 'text';
                effectInput.id = `trait-${traitType}-effect-${index}`;
                effectInput.dataset.dynamicRow = "true";
                grid.appendChild(traitInput);
                grid.appendChild(effectInput);
            }

            function addSimpleGridRow(grid) {
                const index = grid.querySelectorAll('[data-dynamic-row]').length / 2;
                const type = grid.id.split('-')[0];
                const newRow = document.createElement('div');
                newRow.style.display = 'contents';
                newRow.innerHTML = `<input type="text" id="${type}-name-${index}" data-dynamic-row="true"><input type="text" id="${type}-effect-${index}" data-dynamic-row="true">`;
                grid.appendChild(newRow);
            }

            function addSingleColumnRow(grid) {
                const index = grid.querySelectorAll('[data-dynamic-row]').length;
                const type = grid.id.split('-')[0];
                const newRow = document.createElement('div');
                newRow.style.display = 'contents';
                newRow.innerHTML = `<input type="text" id="${type}-name-${index}" data-dynamic-row="true">`;
                grid.appendChild(newRow);
            }
            
            function addSpecialAbilityRow(container) {
                const index = container.querySelectorAll('.skill-row[data-dynamic-row]').length;
                container.appendChild(createEditableSkillRow(`special-${index}`));
            }

            function addAttackRow() {
                const container = document.getElementById('attack-rows');
                const index = container.querySelectorAll('[data-dynamic-row]').length / 4;
                const row = document.createElement('div');
                row.style.display = 'contents'; 
                row.innerHTML = `<input type="text" id="attack-name-${index}" aria-label="Attack ${index} Name" class="attack-name" data-dynamic-row="true"><input type="text" id="attack-score-${index}" aria-label="Attack ${index} Score" class="attack-score" data-dynamic-row="true"><input type="text" id="attack-damage-${index}" aria-label="Attack ${index} Damage" class="attack-damage" data-dynamic-row="true"><input type="text" id="attack-notes-${index}" aria-label="Attack ${index} Notes" class="attack-notes" data-dynamic-row="true">`;
                container.appendChild(row);
            }

            // --- POPULATION FUNCTIONS ---
            function populateSkillContainer(containerId, data) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = ''; 

                for (const groupName in data) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'skill-group';
                    const header = document.createElement('h4');
                    header.className = 'skill-group-header';
                    header.textContent = groupName.trim();
                    groupDiv.appendChild(header);
                    const headerRow = document.createElement('div');
                    headerRow.className = 'skill-row header';
                    headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
                    groupDiv.appendChild(headerRow);
                    const groupData = data[groupName];
                    if (groupData.skills) {
                        groupData.skills.forEach(skillName => {
                            const skillId = `${groupName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                            groupDiv.appendChild(createSkillRow(skillName, skillId));
                        });
                    }
                    if (groupData.subcategories) {
                        for (const subcatName in groupData.subcategories) {
                            const subcatHeader = document.createElement('h5');
                            subcatHeader.className = 'skill-subcategory-header';
                            subcatHeader.textContent = subcatName;
                            groupDiv.appendChild(subcatHeader);
                            groupData.subcategories[subcatName].forEach(skillName => {
                                const skillId = `${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                                groupDiv.appendChild(createSkillRow(skillName, skillId));
                            });
                        }
                    }
                    container.appendChild(groupDiv);
                }
            }

            function populateMetafocus() {
                const container = document.getElementById('metafocus-skills-list');
                container.innerHTML = '';
                const headerRow = document.createElement('div');
                headerRow.className = 'skill-row header';
                headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
                container.appendChild(headerRow);
                
                container.appendChild(createSkillRow("Attune", "metafocus-attune"));

                const columnsDiv = document.createElement('div');
                columnsDiv.className = 'columns-2 equal-width';
                const leftCol = document.createElement('div');
                leftCol.className = 'skills-column';
                leftCol.id = 'metafocus-skills-list-left';
                const rightCol = document.createElement('div');
                rightCol.className = 'skills-column';
                rightCol.id = 'metafocus-skills-list-right';

                const leftSkills = ["Dimension", "Energy", "Entropy"];
                
                for (const subcatName in metafocusData) {
                    if (subcatName === 'Attune') continue;
                    
                    if(metafocusData[subcatName].length > 0) { 
                         const targetCol = leftSkills.includes(subcatName) ? leftCol : rightCol;
                         const groupDiv = document.createElement('div');
                         groupDiv.className = 'skill-group';
                        
                        const subcatHeader = document.createElement('h5');
                        subcatHeader.className = 'skill-subcategory-header';
                        subcatHeader.textContent = subcatName;
                        groupDiv.appendChild(subcatHeader);
                        
                        metafocusData[subcatName].forEach(skillName => {
                            const skillId = `metafocus-${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                            groupDiv.appendChild(createSkillRow(skillName, skillId));
                        });
                        targetCol.appendChild(groupDiv);
                    }
                }
                columnsDiv.appendChild(leftCol);
                columnsDiv.appendChild(rightCol);
                container.appendChild(columnsDiv);
            }
            
            function populateFolio1() {
                addSingleColumnRow(document.getElementById('modifiers-list'));
                addAttackRow();
            }

            function populateFolio2() {
                const traitsContainerLeft = document.getElementById('traits-list-left');
                const traitsContainerRight = document.getElementById('traits-list-right');
                
                traitsContainerLeft.innerHTML = '';
                traitsContainerRight.innerHTML = '';


                const createTraitGrid = (traitType) => {
                    const traitGrid = document.createElement('div');
                    traitGrid.className = 'trait-grid';
                    traitGrid.dataset.traitType = traitType.toLowerCase();
                    traitGrid.innerHTML = `<h5>${traitType}</h5><div class="grid-header">Trait</div><div class="grid-header">Effect</div>`;
                    addTraitRow(traitGrid, traitType.toLowerCase());
                    return traitGrid;
                }

                if (!traitsContainerLeft || !traitsContainerRight) return;
                
                ['Species', 'Origin'].forEach(traitType => {
                    traitsContainerLeft.appendChild(createTraitGrid(traitType));
                });
                
                ['Occupation', 'Faction'].forEach(traitType => {
                     traitsContainerRight.appendChild(createTraitGrid(traitType));
                });

                ['invocations-list', 'augmentations-list', 'features-list', 'other-traits-list', 'disadvantages-list', 'special-abilities-list'].forEach(id => {
                    const el = document.getElementById(id);
                    while(el.children.length > (el.classList.contains('simple-grid') ? 2 : (el.id === 'special-abilities-list' ? 0 : 1))) {
                        el.removeChild(el.lastChild);
                    }
                });

                addSimpleGridRow(document.getElementById('invocations-list'));
                addSimpleGridRow(document.getElementById('augmentations-list'));
                addSimpleGridRow(document.getElementById('features-list'));
                addSingleColumnRow(document.getElementById('other-traits-list'));
                addSingleColumnRow(document.getElementById('disadvantages-list'));
                addSpecialAbilityRow(document.getElementById('special-abilities-list'));
            }

            function populateFolio3() {
                ['mecha-list', 'gear-list', 'miscellaneous-list'].forEach(id => {
                    const el = document.getElementById(id);
                    while(el.children.length > 1) { el.removeChild(el.lastChild); }
                });
                addSingleColumnRow(document.getElementById('mecha-list'));
                addSingleColumnRow(document.getElementById('gear-list'));
                addSingleColumnRow(document.getElementById('miscellaneous-list'));
            }
            
            function populateFolio4() {
                 const el = document.getElementById('notes-list');
                 while(el.children.length > 0) { el.removeChild(el.lastChild); } // No header here
                addSingleColumnRow(document.getElementById('notes-list'));
            }

            // --- CALCULATIONS & EVENT HANDLING ---
            const calculateSkillTotal = (skillRow) => {
                const rank = parseInt(skillRow.querySelector('.skill-rank')?.value) || 0;
                const mod = parseInt(skillRow.querySelector('.skill-mod')?.value) || 0;
                const totalInput = skillRow.querySelector('.skill-total');
                const selectElement = skillRow.querySelector('.skill-base-select');
                let baseValue = 0;
                if (selectElement) {
                    const selectedAttributeId = selectElement.value;
                    if (selectedAttributeId) {
                        const attributeInput = document.getElementById(selectedAttributeId);
                        if (attributeInput) {
                            baseValue = parseInt(attributeInput.value) || 0;
                        }
                    }
                }
                if (totalInput) {
                    totalInput.value = rank + baseValue + mod;
                }
            };

            function handleDynamicRowCreation(event) {
                const target = event.target;
                if (!target.dataset.dynamicRow) return;

                const traitGrid = target.closest('.trait-grid');
                if (traitGrid) {
                    const inputs = Array.from(traitGrid.querySelectorAll('[data-dynamic-row]'));
                    if (inputs.indexOf(target) >= inputs.length - 2) {
                        addTraitRow(traitGrid, traitGrid.dataset.traitType);
                    }
                    return;
                }

                const simpleGrid = target.closest('.simple-grid');
                if(simpleGrid) {
                    const inputs = Array.from(simpleGrid.querySelectorAll('[data-dynamic-row]'));
                    if (inputs.indexOf(target) >= inputs.length - 2) {
                       addSimpleGridRow(simpleGrid);
                    }
                    return;
                }

                const singleGrid = target.closest('.single-column-grid');
                if(singleGrid) {
                    const inputs = Array.from(singleGrid.querySelectorAll('[data-dynamic-row]'));
                    if (target === inputs[inputs.length - 1]) {
                        addSingleColumnRow(singleGrid);
                    }
                    return;
                }

                const specialList = target.closest('#special-abilities-list');
                if(specialList) {
                    const inputs = Array.from(specialList.querySelectorAll('[data-dynamic-row]'));
                    if(inputs.indexOf(target) >= inputs.length - 5) { // 5 inputs per row
                        addSpecialAbilityRow(specialList);
                    }
                    return;
                }
                
                const attackGrid = target.closest('#attack-rows');
                if(attackGrid) {
                    const inputs = Array.from(attackGrid.querySelectorAll('[data-dynamic-row]'));
                    if(inputs.indexOf(target) >= inputs.length - 4) {
                        addAttackRow();
                    }
                }
            }

            sheet.addEventListener('input', (event) => {
                if (event.target.matches('.skill-rank, .skill-mod, .attribute-input')) {
                     const skillRow = event.target.closest('.skill-row');
                    if (skillRow) {
                        calculateSkillTotal(skillRow);
                    }
                    if (event.target.matches('.attribute-input')) {
                        const changedAttributeId = event.target.id;
                        document.querySelectorAll('.skill-base-select').forEach(select => {
                            if (select.value === changedAttributeId) {
                                calculateSkillTotal(select.closest('.skill-row'));
                            }
                        });
                    }
                }
                handleDynamicRowCreation(event);
            });

            sheet.addEventListener('change', (event) => {
                if (event.target.matches('.skill-base-select')) {
                    calculateSkillTotal(event.target.closest('.skill-row'));
                }
            });

            // --- DATA IMPORT/EXPORT (LOCAL AND CLOUD) ---
            const getCharacterData = () => {
                const data = {};
                const inputs = sheet.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.id) {
                        data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                    }
                });
                return data;
            };

            const loadCharacterData = (data) => {
                // Reset the sheet to a clean slate before loading
                populateFolio1();
                populateFolio2();
                populateFolio3();
                populateFolio4();

                const dynamicCounts = {};
                const idPrefixes = ['trait-species-trait-', 'trait-origin-trait-', 'trait-occupation-trait-', 'trait-faction-trait-', 'attack-name-', 'features-name-', 'invocations-name-', 'augmentations-name-', 'modifiers-name-', 'disadvantages-name-', 'other-traits-name-', 'gear-name-', 'mecha-name-', 'miscellaneous-name-', 'notes-name-', 'skill-special-name-'];

                for(const id in data) {
                    for(const prefix of idPrefixes) {
                        if(id.startsWith(prefix)) {
                            dynamicCounts[prefix] = (dynamicCounts[prefix] || 0) + 1;
                        }
                    }
                }
                
                // Add necessary rows for each dynamic section
                for(const prefix in dynamicCounts) {
                    const count = dynamicCounts[prefix];
                    for(let i=0; i < count - 1; i++){ // -1 because one row exists by default
                        if(prefix.startsWith('trait-')) {
                            const type = prefix.split('-')[1];
                            const container = document.getElementById(`traits-list-${type === 'species' || type === 'origin' ? 'left' : 'right'}`);
                            const grid = container?.querySelector(`[data-trait-type="${type}"]`);
                            if (grid) addTraitRow(grid, type);
                        } else if(prefix === 'attack-name-') {
                            addAttackRow();
                        } else if (['features-name-', 'invocations-name-', 'augmentations-name-'].includes(prefix)) {
                            addSimpleGridRow(document.getElementById(prefix.replace('-name-', '-list')));
                        } else if (prefix === 'skill-special-name-') {
                            addSpecialAbilityRow(document.getElementById('special-abilities-list'));
                        } else {
                            addSingleColumnRow(document.getElementById(prefix.replace('-name-', '-list')));
                        }
                    }
                }

                // Now populate all fields
                for (const id in data) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.tagName === 'SELECT') {
                            if ([...element.options].some(opt => opt.value === data[id])) {
                                element.value = data[id];
                            }
                        } else {
                            element.value = data[id];
                        }
                    }
                }
                
                // Recalculate all skill totals after loading
                document.querySelectorAll('.skill-row[data-skill-id]').forEach(calculateSkillTotal);
            };
            
            // --- CLOUD SAVE/LOAD ---
            cloudSaveBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) {
                    showModal("You must be logged in to save.");
                    return;
                }
                const privateSheets = getPrivateCollection(user.uid);
                
                const characterData = getCharacterData();
                const characterName = document.getElementById('char-name').value;
                
                if (!characterName.trim()) {
                    showModal("Please enter a Character Name before saving.");
                    return;
                }
                
                try {
                    const sheetId = sheet.dataset.firestoreId;
                    if (sheetId) {
                        await setDoc(doc(privateSheets, sheetId), characterData);
                        showModal(`'${characterName}' updated in the cloud!`);
                    } else {
                        const docRef = await addDoc(privateSheets, characterData);
                        sheet.dataset.firestoreId = docRef.id;
                        showModal(`'${characterName}' saved to the cloud!`);
                    }
                } catch (error) {
                    console.error("Error saving to Firestore: ", error);
                    showModal("Failed to save to the cloud. See console for details.");
                }
            });

            cloudLoadBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) {
                    showModal("You must be logged in to load.");
                    return;
                }
                const privateSheets = getPrivateCollection(user.uid);

                try {
                    const querySnapshot = await getDocs(privateSheets);
                    if (querySnapshot.empty) {
                        showModal("No characters found in your cloud storage.");
                        return;
                    }

                    const characterChoices = querySnapshot.docs.map(doc => ({
                        text: doc.data()['char-name'] || 'Unnamed Character',
                        value: doc.id
                    }));

                    const selectedDocId = await showModal("Select a character to load:", {
                        choices: characterChoices,
                        showCancel: true
                    });

                    if (!selectedDocId) return; // User cancelled

                    const selectedDoc = querySnapshot.docs.find(doc => doc.id === selectedDocId);
                    if (selectedDoc) {
                        loadCharacterData(selectedDoc.data());
                        sheet.dataset.firestoreId = selectedDoc.id;
                        showModal(`'${selectedDoc.data()['char-name']}' loaded successfully.`);
                    }

                } catch (error) {
                    console.error("Error listing characters from Firestore: ", error);
                    showModal("Failed to list characters from the cloud. See console for details.");
                }
            });
            
            // --- SHARE FUNCTIONALITY ---
            shareBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                 if (!user) {
                    showModal("You must be logged in to share.");
                    return;
                }
                const privateSheetId = sheet.dataset.firestoreId;
                if (!privateSheetId) {
                    showModal("Please save the character to the cloud first to get a shareable link.");
                    return;
                }
            
                const privateSheets = getPrivateCollection(user.uid);

                try {
                    const privateDocRef = doc(privateSheets, privateSheetId);
                    const docSnap = await getDoc(privateDocRef);
            
                    if (!docSnap.exists()) {
                        showModal("Cannot find the character data to share.");
                        return;
                    }
                    const characterData = docSnap.data();
            
                    const publicSheets = getPublicCollection();
                    const publicDocRef = doc(publicSheets, privateSheetId);
                    await setDoc(publicDocRef, characterData);

                    const shareableLink = `${window.location.origin}${window.location.pathname}?sheet=${privateSheetId}`;
                    
                    showModal(
                        "Anyone with this link can view this character sheet.", 
                        {
                            prompt: true,
                            inputValue: shareableLink,
                            readOnly: true,
                            showCopy: true,
                        }
                    );
                    
                } catch (error) {
                    console.error("Error creating share link: ", error);
                    showModal("Could not create a share link. See console for details.");
                }
            });

            // --- LOCAL SAVE/LOAD ---
            const downloadFile = (filename, content, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const saveAsJson = () => {
                const data = getCharacterData();
                const charName = (data['char-name'] || 'character').replace(/\s+/g, '_');
                downloadFile(`${charName}_folio.json`, JSON.stringify(data, null, 2), 'application/json');
            };

            const loadJsonInput = document.getElementById('load-json-input');
            document.getElementById('load-json-btn').addEventListener('click', () => loadJsonInput.click());
            loadJsonInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadCharacterData(data);
                        sheet.dataset.firestoreId = ''; // Clear Firestore ID when loading local file
                    } catch (error) {
                        showModal("Error parsing JSON file. It may be invalid.");
                        console.error(error);
                    }
                };
                reader.readAsText(file);
                loadJsonInput.value = ''; // Reset for re-uploading same file
            });

            // --- PDF & MARKDOWN EXPORT ---
            document.getElementById('save-pdf-btn').addEventListener('click', () => showModal("PDF generation coming soon!"));
            document.getElementById('save-md-btn').addEventListener('click', () => showModal("Markdown export coming soon!"));

            // --- INITIALIZATION ---
            const loadSharedSheet = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const sharedSheetId = urlParams.get('sheet');
                if (sharedSheetId && db) { // Ensure db is initialized
                    try {
                        const publicDocRef = doc(getPublicCollection(), sharedSheetId);
                        const docSnap = await getDoc(publicDocRef);
                        if (docSnap.exists()) {
                            loadCharacterData(docSnap.data());
                            sheet.dataset.firestoreId = ''; // It's a shared copy, not the original
                            showModal("Loaded shared character sheet.");
                        } else {
                            showModal("Shared character sheet not found.");
                        }
                    } catch (error) {
                        console.error("Error loading shared sheet: ", error);
                        showModal("Could not load the shared character sheet.");
                    }
                }
            };
            
            // Populate the sheet on initial load
            populateSkillContainer('skills-list-left', mentalSkillData);
            populateSkillContainer('skills-list-right', otherSkillData);
            populateMetafocus();
            populateFolio1();
            populateFolio2();
            populateFolio3();
            populateFolio4();
            document.querySelectorAll('.skill-row[data-skill-id]').forEach(calculateSkillTotal);

            // Check for a shared sheet after initial population
            loadSharedSheet();
        });
    </script>
</body>
</html>
