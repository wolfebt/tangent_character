<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tangent SFF RPG Persona Folio</title>
    <!-- Google Fonts for the web page styling -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- pdfmake library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js" xintegrity="sha512-w61kvDEdEh9PzJIZhJ4MVIy/MJoCHucfbzH2K8MAoYAiA93gs/o2yBDR8AstsTUr86gNIlr4FwyG3DRL32S+zA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- pdfmake requires a virtual file system for fonts. The default CDN only includes Roboto. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js" xintegrity="sha512-nNkHPz+lD0Wf0eF_HsscpfrAYuEtF96SQXo2iQDrBCGucwKNYf9A1wL4hZPAy2oUv41NS1QeRbeBC5lAa3T7Jw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* style.css content is now embedded in the HTML file for simplicity */
        :root {
            /* New darker greyscale palette for high contrast */
            --bg-color: #212121; /* Dark page background */
            --section-bg: #424242; /* Lighter grey for sections */
            --text-color: #f5f5f5; /* Light grey text */
            --border-color: #9e9e9e; /* Lighter grey for borders */
            --subtle-border: #616161; /* Darker grey for internal lines */
            --header-bg: #333333; 
            --header-text: #eeeeee; 
            --input-bg: #616161; /* Mid-grey for inputs */
            --input-text: #ffffff;
            --font-body: 'Roboto Condensed', sans-serif; 
            --font-display: 'Roboto', sans-serif;
            --spacing-xs: 0.25rem; --spacing-sm: 0.5rem; --spacing-md: 1rem; --spacing-lg: 1.5rem;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: var(--spacing-md); 
        }
        .character-sheet { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-lg); 
        }
        .main-section { 
            border: 2px solid var(--border-color); 
            padding: var(--spacing-lg); 
            background-color: var(--section-bg); 
            border-radius: 8px;
        }
        .sheet-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center; 
            font-family: var(--font-display); 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: var(--spacing-lg); 
            padding-bottom: var(--spacing-md); 
        }
        .sheet-header h1 { margin: 0; color: var(--text-color); flex-grow: 1; text-align: center; padding-left: 100px; /* Offset for file menu */}
        .creator-credit {
            text-align: center;
            margin-top: var(--spacing-lg);
            font-size: 0.8rem;
            color: var(--header-text);
            font-family: var(--font-display);
            letter-spacing: 2px;
        }
        /* File Menu Styles */
        .file-menu { position: relative; width: 100px; /* Give it a fixed width */ }
        .file-menu-button {
            font-family: var(--font-body); 
            font-weight: bold; 
            font-size: 0.9rem; 
            padding: 0.75rem var(--spacing-md); 
            border: 2px solid var(--header-text); 
            border-radius: 5px;
            background-color: var(--header-bg); 
            color: #ffffff; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; 
            text-shadow: 1px 1px 2px #000;
        }
        .file-menu-button:hover {
            background-color: #eeeeee; 
            color: #212121;
            border-color: #eeeeee; 
            text-shadow: none;
        }
        .file-menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 5px;
            padding: var(--spacing-sm);
            z-index: 100;
            min-width: 200px;
        }
        .file-menu-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: var(--spacing-sm);
            background-color: var(--input-bg);
            color: var(--input-text);
            border-radius: 3px;
            border: none;
            padding: var(--spacing-sm);
            cursor: pointer;
        }
        .file-menu-dropdown button:hover {
            background-color: var(--input-bg);
            filter: brightness(1.2);
        }
        .file-menu-dropdown button:last-child { margin-bottom: 0; }
        .file-menu-dropdown.show { display: block; }
        #load-json-input { display: none; }

        .columns-2 { display: flex; gap: var(--spacing-lg); }
        .columns-2 > .col-left { flex: 2; }
        .columns-2 > .col-right { flex: 1; }
        .columns-2.equal-width > * {
            flex: 1;
        }
        fieldset { 
            border: 2px solid var(--border-color); 
            border-radius: 4px;
            padding: var(--spacing-md); 
            margin: 0 0 var(--spacing-lg) 0; 
        }
        fieldset:last-child { margin-bottom: 0; }
        legend { 
            font-weight: bold; 
            padding: 0 var(--spacing-sm); 
            font-family: var(--font-display); 
            text-transform: uppercase; 
        }
        .input-group { display: flex; flex-direction: column; }
        .input-group.full-width { grid-column: 1 / -1; }
        label { margin-bottom: var(--spacing-xs); font-size: 0.875rem; font-weight: bold; color: var(--header-text); }
        input[type="text"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: var(--spacing-sm); 
            border: 1.5px solid var(--border-color); 
            border-radius: 4px;
            background-color: var(--input-bg); 
            color: var(--input-text);
            font-family: var(--font-body); 
            font-size: 1rem; 
        }
        textarea { resize: vertical; }

        /* Grid Layouts */
        .bio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md) var(--spacing-lg);
        }
        .vitals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md); }
        .attributes-container { display: flex; gap: var(--spacing-md); }
        .attribute-column { flex: 1; display: flex; flex-direction: column; gap: var(--spacing-md); }
        .attribute-group { display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto; gap: 0 var(--spacing-sm); align-items: center; }
        
        .attribute-group label:nth-of-type(1) { 
            grid-column: 1; 
            grid-row: 1; 
            font-size: 1.05rem;
        }
        .attribute-group input:nth-of-type(1) { grid-column: 2; grid-row: 1; width: 60px; }
        .attribute-group label:nth-of-type(2) { 
            grid-column: 1; 
            grid-row: 2; 
            font-size: 0.8rem; 
            padding-left: var(--spacing-md);
            font-style: italic;
        }
        .attribute-group input:nth-of-type(2) { grid-column: 2; grid-row: 2; width: 42px; }
        
        .attack-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 3fr; gap: var(--spacing-sm); align-items: center; }
        .armor-grid { display: grid; grid-template-columns: 1fr 1fr 4fr; gap: var(--spacing-sm) var(--spacing-md); align-items: center; }
        .armor-grid label { font-weight: bold; margin-bottom: 0; }
        .attack-header, .armor-header, .grid-header { font-weight: bold; font-size: 0.8rem; color: var(--header-text); border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); }

        .core-stats-container { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .ratings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
        .move-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-md); }
        .perception-grid { display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-xs) var(--spacing-sm); align-items: center;}
        .perception-grid > input:first-child { grid-column: 1 / -1; margin-bottom: var(--spacing-sm); }
        .perception-grid label { text-align: right; }


        /* Skills Section */
        .skills-column {
             display: flex;
             flex-direction: column;
             gap: var(--spacing-lg);
        }
        .skill-group { break-inside: avoid; }
        .skill-group-header { background-color: var(--header-bg); padding: var(--spacing-sm); margin: 0 0 var(--spacing-sm) 0; text-align: center; font-family: var(--font-display); text-transform: uppercase; border: 1.5px solid var(--subtle-border);}
        .skill-subcategory-header {
            font-family: var(--font-body);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            color: var(--header-text);
            padding-left: var(--spacing-sm);
            margin: var(--spacing-md) 0 var(--spacing-sm) 0;
            border-bottom: 1.5px solid var(--subtle-border);
        }
        .skill-row { display: grid; grid-template-columns: 2.5fr 1fr 1.5fr 1fr 1fr; gap: var(--spacing-sm); align-items: center; margin-bottom: var(--spacing-sm); }
        .skill-row.header { font-weight: bold; text-align: center; font-size: 0.8rem; color: var(--header-text); }
        .skill-row.header span { border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); }
        .skill-row label { font-weight: normal; margin-bottom: 0; color: var(--text-color); }
        .skill-row input, .skill-row select { text-align: center; padding: var(--spacing-xs); font-size: 0.9rem; }
        .skill-row input.skill-name-input {
            text-align: left;
            font-style: italic;
        }
        .skill-row .skill-total { background-color: var(--header-bg); font-weight: bold; }

        /* Folio 2 & 3 Specifics */
        .trait-grid { display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-sm) var(--spacing-md); }
        .trait-grid-container { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .trait-grid h5 { margin: 0; grid-column: 1 / -1; font-family: var(--font-display); text-transform: uppercase; border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); margin-bottom: var(--spacing-sm); }
        .trait-grid .grid-header { font-weight: bold; font-size: 0.8rem; color: var(--header-text); }
        .simple-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .single-column-grid { display: grid; grid-template-columns: 1fr; gap: var(--spacing-sm); }


        /* Responsive */
        @media (max-width: 768px) {
            .columns-2 { flex-direction: column; }
            .bio-grid { grid-template-columns: 1fr; }
            .vitals-grid, .ratings-grid, .move-grid { grid-template-columns: 1fr 1fr; }
            .attributes-container { flex-direction: column; }
            .skills-column { gap: 0; }
        }
    </style>
</head>
<body>

    <form class="character-sheet">
        <header class="sheet-header">
            <div style="width: 100px;"></div> <!-- Spacer -->
            <h1>Tangent SFF RPG Persona Folio</h1>
             <div class="file-menu">
                <button type="button" class="file-menu-button">File</button>
                <div class="file-menu-dropdown">
                    <button type="button" id="save-json-btn">Save</button>
                    <button type="button" id="load-json-btn">Load</button>
                    <button type="button" id="save-pdf-btn">Print PDF</button>
                    <button type="button" id="save-md-btn">Print Markdown</button>
                </div>
                <input type="file" id="load-json-input" accept=".json">
            </div>
        </header>
        
        <section class="main-section" id="bio-section">
            <fieldset><legend>Character Information</legend>
                <div class="bio-grid">
                    <div class="input-group"><label for="char-name">Name</label><input type="text" id="char-name" name="char-name"></div>
                    <div class="input-group"><label for="char-concept">Concept</label><input type="text" id="char-concept" name="char-concept"></div>
                    <div class="input-group"><label for="char-species">Species</label><input type="text" id="char-species" name="char-species"></div>
                    <div class="input-group"><label for="char-occu">Occupation</label><input type="text" id="char-occu" name="char-occu"></div>
                    <div class="input-group"><label for="char-origin">Origin</label><input type="text" id="char-origin" name="char-origin"></div>
                    <div class="input-group"><label for="char-faction">Faction</label><input type="text" id="char-faction" name="char-faction"></div>
                    <div class="input-group"><label for="char-age">Age</label><input type="text" id="char-age" name="char-age"></div>
                    <div class="input-group"><label for="char-gender">Gender</label><input type="text" id="char-gender" name="char-gender"></div>
                    <div class="input-group"><label for="char-height">Height</label><input type="text" id="char-height" name="char-height"></div>
                    <div class="input-group"><label for="char-weight">Weight</label><input type="text" id="char-weight" name="char-weight"></div>
                    <div class="input-group full-width"><label for="char-style">Description / Style</label><textarea id="char-style" name="char-style" rows="2"></textarea></div>
                    <div class="input-group full-width"><label for="char-motive">Personality / Motive</label><textarea id="char-motive" name="char-motive" rows="2"></textarea></div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="attributes-stats-section">
             <div class="columns-2">
                <div class="col-left">
                    <fieldset><legend>Primary Attributes</legend>
                        <div class="attributes-container">
                            <div class="attribute-column">
                                <div class="attribute-group"><label for="attr-strength">Strength</label><input type="number" id="attr-strength" class="attribute-input"><label for="attr-might">Might</label><input type="number" id="attr-might"></div>
                                <div class="attribute-group"><label for="attr-agility">Agility</label><input type="number" id="attr-agility" class="attribute-input"><label for="attr-reflex">Reflex</label><input type="number" id="attr-reflex"></div>
                                <div class="attribute-group"><label for="attr-constitution">Constitution</label><input type="number" id="attr-constitution" class="attribute-input"><label for="attr-fortitude">Fortitude</label><input type="number" id="attr-fortitude"></div>
                            </div>
                            <div class="attribute-column">
                                <div class="attribute-group"><label for="attr-intellect">Intellect</label><input type="number" id="attr-intellect" class="attribute-input"><label for="attr-logic">Logic</label><input type="number" id="attr-logic"></div>
                                <div class="attribute-group"><label for="attr-wisdom">Wisdom</label><input type="number" id="attr-wisdom" class="attribute-input"><label for="attr-will">Will</label><input type="number" id="attr-will"></div>
                                <div class="attribute-group"><label for="attr-charisma">Charisma</label><input type="number" id="attr-charisma" class="attribute-input"><label for="attr-etiquette">Etiquette</label><input type="number" id="attr-etiquette"></div>
                            </div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Modifiers</legend>
                        <div class="single-column-grid" id="modifiers-list">
                            <!-- Modifiers will be dynamically populated -->
                        </div>
                    </fieldset>
                </div>
                <div class="col-right">
                    <fieldset><legend>Core Stats</legend>
                        <div class="vitals-grid">
                            <div class="input-group"><label for="health">Health</label><input type="number" id="health"></div>
                            <div class="input-group"><label for="vitality">Vitality</label><input type="number" id="vitality"></div>
                            <div class="input-group"><label for="initiative">Initiative</label><input type="number" id="initiative"></div>
                        </div>
                    </fieldset>
                    <fieldset><legend>Ratings</legend>
                        <div class="ratings-grid">
                            <div class="input-group"><label for="karma">Karma</label><input type="number" id="karma"></div>
                            <div class="input-group"><label for="plot-points">Plot Points</label><input type="number" id="plot-points"></div>
                            <div class="input-group"><label for="tech-level">Tech Level</label><input type="text" id="tech-level"></div>
                            <div class="input-group"><label for="wealth">Wealth</label><input type="text" id="wealth"></div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Move</legend>
                        <div class="move-grid">
                            <div class="input-group"><label for="move-walk">Walk</label><input type="text" id="move-walk"></div>
                            <div class="input-group"><label for="move-swim">Swim</label><input type="text" id="move-swim"></div>
                            <div class="input-group"><label for="move-climb">Climb</label><input type="text" id="move-climb"></div>
                            <div class="input-group"><label for="move-fly">Fly</label><input type="text" id="move-fly"></div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Perception</legend>
                        <div class="perception-grid">
                            <input type="number" id="perception">
                            <label for="perception-meta">Meta</label><input type="number" id="perception-meta">
                            <label for="perception-social">Social</label><input type="number" id="perception-social">
                            <label for="perception-tech">Technology</label><input type="number" id="perception-tech">
                        </div>
                    </fieldset>
                </div>
            </div>
        </section>

        <section class="main-section" id="skills-section">
            <fieldset><legend>Skills</legend>
                <div class="columns-2 equal-width">
                    <div id="skills-list-left" class="skills-column">
                        <!-- Mental skills will be dynamically populated by JavaScript -->
                    </div>
                    <div id="skills-list-right" class="skills-column">
                        <!-- Other skills will be dynamically populated by JavaScript -->
                    </div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="combat-section">
             <fieldset><legend>Attack</legend>
                <div class="attack-grid" id="attack-rows">
                    <div class="attack-header">Attack</div><div class="attack-header">Score</div><div class="attack-header">Damage</div><div class="attack-header">Notes</div>
                    <!-- Attack rows will be populated by JS -->
                </div>
            </fieldset>
            
            <fieldset><legend>Armor Location</legend>
                <div class="armor-grid" id="armor-rows">
                    <div class="armor-header">Location</div><div class="armor-header">Total DR</div><div class="armor-header">Notes</div>
                    <label for="armor-head">Head</label><input type="text" id="armor-head-dr"><input type="text" id="armor-head-notes">
                    <label for="armor-torso">Torso</label><input type="text" id="armor-torso-dr"><input type="text" id="armor-torso-notes">
                    <label for="armor-right-arm">Right Arm</label><input type="text" id="armor-right-arm-dr"><input type="text" id="armor-right-arm-notes">
                    <label for="armor-left-arm">Left Arm</label><input type="text" id="armor-left-arm-dr"><input type="text" id="armor-left-arm-notes">
                    <label for="armor-right-leg">Right Leg</label><input type="text" id="armor-right-leg-dr"><input type="text" id="armor-right-leg-notes">
                    <label for="armor-left-leg">Left Leg</label><input type="text" id="armor-left-leg-dr"><input type="text" id="armor-left-leg-notes">
                </div>
            </fieldset>
        </section>
        
        <section class="main-section" id="folio-2">
            <fieldset><legend>Traits</legend>
                <div class="columns-2 equal-width">
                    <div id="traits-list-left" class="trait-grid-container"></div>
                    <div id="traits-list-right" class="trait-grid-container"></div>
                </div>
            </fieldset>
        </section>
        
        <section class="main-section" id="features-and-traits-section">
             <fieldset><legend>Features</legend>
                <div class="simple-grid" id="features-list">
                    <div class="grid-header">Feature</div><div class="grid-header">Effect</div>
                    <!-- Feature rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Disadvantages</legend>
                <div class="single-column-grid" id="disadvantages-list">
                    <!-- Disadvantage rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Augmentations</legend>
                <div class="simple-grid" id="augmentations-list">
                    <div class="grid-header">Augmentation</div><div class="grid-header">Effect</div>
                    <!-- Augmentation rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Other Traits</legend>
                <div class="single-column-grid" id="other-traits-list">
                    <!-- Dynamic rows -->
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="metafocus-section">
            <fieldset><legend>Metafocus</legend>
                 <div class="skill-group" id="metafocus-skills-list">
                     <!-- Metafocus skills will be populated here -->
                 </div>
                 <hr>
                 <h5 class="skill-subcategory-header" style="text-align:center; margin-top: 1rem;">Invocations</h5>
                 <div class="simple-grid" id="invocations-list">
                     <div class="grid-header">Invocation</div><div class="grid-header">Level</div>
                 </div>
                 <hr>
                 <h5 class="skill-subcategory-header" style="text-align:center; margin-top: 1rem;">Special Abilities</h5>
                 <div id="special-abilities-list">
                 </div>
            </fieldset>
        </section>


        <section class="main-section" id="folio-3">
             <fieldset><legend>Gear</legend>
                <div class="single-column-grid" id="gear-list">
                     <div class="grid-header">Gear</div>
                </div>
            </fieldset>
            <fieldset><legend>Mecha</legend>
                <div class="single-column-grid" id="mecha-list">
                     <div class="grid-header">Mecha</div>
                </div>
            </fieldset>
            <fieldset><legend>Miscellaneous</legend>
                 <div class="single-column-grid" id="miscellaneous-list">
                     <div class="grid-header">Item</div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="folio-4">
             <fieldset><legend>Notes</legend>
                <div class="single-column-grid" id="notes-list">
                    <!-- Notes rows will be populated -->
                </div>
            </fieldset>
        </section>

    </form>
    
    <footer class="creator-credit">
        WOLFE.BT@TANGENTLLC
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Character sheet script loaded. 🚀");

            const sheet = document.querySelector('.character-sheet');
            
            // --- DATA & SETUP ---

            const attributeOptions = [
                { value: 'attr-strength', text: 'Strength' },
                { value: 'attr-agility', text: 'Agility' },
                { value: 'attr-constitution', text: 'Constitution' },
                { value: 'attr-intellect', text: 'Intellect' },
                { value: 'attr-wisdom', text: 'Wisdom' },
                { value: 'attr-charisma', text: 'Charisma' },
            ];

            const mentalSkillData = {
                "Mental": {
                    "skills": ["Alertness"],
                    "subcategories": {
                        "Knowledge": ["Academics", "Appraisal", "Computers", "Culture", "History", "Investigation", "Language", "Medicine", "Nature", "Navigation", "Nobility", "Physics", "Religion", "Science", "Survival", "Tactics", "Technology"],
                        "Vocation": ["Administrator", "Alchemist", "Ambassador", "Architect", "Archivist", "Armorer", "Artist", "Artificer", "Broker", "Celebrity", "Constable", "Courtesan", "Culinarian", "Demolitionist", "Electrician", "Engineer", "Groundskeeper", "Handler", "Laborer", "Mechanic", "Researcher", "Salvager", "Soldier", "Tailor", "Transporter", "Weaponsmith"]
                    }
                }
            };

            const otherSkillData = {
                 "Physical": {
                    "skills": ["Acrobatics", "Athletics", "Piloting", "Stealth"]
                },
                "Social": {
                     "subcategories": {
                        "Manipulation": ["Insight", "Bluff", "Diplomacy", "Intimidate", "Streetwise"],
                        "Expression": ["Acting", "Comedy", "Dancing", "Disguise", "Keyboard", "Legerdemain", "Oratory", "Percussion", "Singing", "String", "Style", "Wind"]
                    }
                },
                "Combat": {
                     "subcategories": {
                        "Archaic": ["Defense", "Melee", "Ranged", "Unarmed"],
                        "Modern": ["Ballistic", "Heavy Weapons"],
                        "Advanced": ["Energy", "Heavy Energy"]
                    }
                }
            };
            
            const metafocusData = {
                "Attune": [], // Attune is a skill on its own
                "Dimension": ["Summoning", "Teleport"],
                "Energy": ["Elemental", "Force"],
                "Entropy": ["Chaos", "Order"],
                "Illusion": ["Phantasmal", "Shadow"],
                "Matter": ["Enhancement", "Transmutation"],
                "Mental": ["Projection", "Sense"]
            };

            function createSkillRow(skillName, skillId) {
                const row = document.createElement('div');
                row.className = 'skill-row';
                row.dataset.skillId = skillId;
                let optionsHtml = '<option value="">--</option>';
                attributeOptions.forEach(opt => {
                    optionsHtml += `<option value="${opt.value}">${opt.text}</option>`;
                });
                row.innerHTML = `
                    <label for="skill-${skillId}-rank">${skillName}</label>
                    <input type="number" id="skill-${skillId}-rank" class="skill-rank" placeholder="0">
                    <select id="skill-${skillId}-base" class="skill-base-select">${optionsHtml}</select>
                    <input type="number" id="skill-${skillId}-mod" class="skill-mod" placeholder="0">
                    <input type="number" id="skill-${skillId}-total" class="skill-total" readonly>
                `;
                return row;
            }

            function createEditableSkillRow(skillId) {
                const row = document.createElement('div');
                row.className = 'skill-row';
                row.dataset.skillId = skillId;
                row.dataset.dynamicRow = "true";
                let optionsHtml = '<option value="">--</option>';
                attributeOptions.forEach(opt => {
                    optionsHtml += `<option value="${opt.value}">${opt.text}</option>`;
                });
                row.innerHTML = `
                    <input type="text" id="skill-${skillId}-name" class="skill-name-input" placeholder="Enter ability name..." data-dynamic-row="true">
                    <input type="number" id="skill-${skillId}-rank" class="skill-rank" placeholder="0" data-dynamic-row="true">
                    <select id="skill-${skillId}-base" class="skill-base-select" data-dynamic-row="true">${optionsHtml}</select>
                    <input type="number" id="skill-${skillId}-mod" class="skill-mod" placeholder="0" data-dynamic-row="true">
                    <input type="number" id="skill-${skillId}-total" class="skill-total" readonly>
                `;
                return row;
            }
            
            function populateSkillContainer(containerId, data) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = ''; 

                for (const groupName in data) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'skill-group';
                    const header = document.createElement('h4');
                    header.className = 'skill-group-header';
                    header.textContent = groupName.trim();
                    groupDiv.appendChild(header);
                    const headerRow = document.createElement('div');
                    headerRow.className = 'skill-row header';
                    headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
                    groupDiv.appendChild(headerRow);
                    const groupData = data[groupName];
                    if (groupData.skills) {
                        groupData.skills.forEach(skillName => {
                            const skillId = `${groupName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                            groupDiv.appendChild(createSkillRow(skillName, skillId));
                        });
                    }
                    if (groupData.subcategories) {
                        for (const subcatName in groupData.subcategories) {
                            const subcatHeader = document.createElement('h5');
                            subcatHeader.className = 'skill-subcategory-header';
                            subcatHeader.textContent = subcatName;
                            groupDiv.appendChild(subcatHeader);
                            groupData.subcategories[subcatName].forEach(skillName => {
                                const skillId = `${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                                groupDiv.appendChild(createSkillRow(skillName, skillId));
                            });
                        }
                    }
                    container.appendChild(groupDiv);
                }
            }
            
            function addTraitRow(grid, traitType) {
                const index = grid.querySelectorAll('[data-dynamic-row="true"]').length / 2;
                const traitInput = document.createElement('input');
                traitInput.type = 'text';
                traitInput.id = `trait-${traitType}-trait-${index}`;
                traitInput.dataset.dynamicRow = "true";
                const effectInput = document.createElement('input');
                effectInput.type = 'text';
                effectInput.id = `trait-${traitType}-effect-${index}`;
                effectInput.dataset.dynamicRow = "true";
                grid.appendChild(traitInput);
                grid.appendChild(effectInput);
            }

            function addSimpleGridRow(grid) {
                const index = grid.querySelectorAll('[data-dynamic-row]').length / 2;
                const type = grid.id.split('-')[0];
                const newRow = document.createElement('div');
                newRow.style.display = 'contents';
                newRow.innerHTML = `<input type="text" id="${type}-name-${index}" data-dynamic-row="true"><input type="text" id="${type}-effect-${index}" data-dynamic-row="true">`;
                grid.appendChild(newRow);
            }
             function addSingleColumnRow(grid) {
                const index = grid.querySelectorAll('[data-dynamic-row]').length;
                const type = grid.id.split('-')[0];
                 const newRow = document.createElement('div');
                newRow.style.display = 'contents';
                newRow.innerHTML = `<input type="text" id="${type}-name-${index}" data-dynamic-row="true">`;
                grid.appendChild(newRow);
            }
            
            function addSpecialAbilityRow(container) {
                 const index = container.querySelectorAll('.skill-row[data-dynamic-row]').length;
                 container.appendChild(createEditableSkillRow(`special-${index}`));
            }


            function populateFolio1() {
                addSingleColumnRow(document.getElementById('modifiers-list'));
                addAttackRow();
            }
            
            function populateMetafocus() {
                const container = document.getElementById('metafocus-skills-list');
                container.innerHTML = ''; // Clear previous content
                const headerRow = document.createElement('div');
                headerRow.className = 'skill-row header';
                headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
                container.appendChild(headerRow);
                
                // Add the top-level Attune skill
                container.appendChild(createSkillRow("Attune", "metafocus-attune"));

                // Add the rest in columns
                const columnsDiv = document.createElement('div');
                columnsDiv.className = 'columns-2 equal-width';
                const leftCol = document.createElement('div');
                leftCol.className = 'skills-column';
                leftCol.id = 'metafocus-skills-list-left';
                const rightCol = document.createElement('div');
                rightCol.className = 'skills-column';
                rightCol.id = 'metafocus-skills-list-right';

                const leftSkills = ["Dimension", "Energy", "Entropy"];
                
                for (const subcatName in metafocusData) {
                    if (subcatName === 'Attune') continue;
                    
                    if(metafocusData[subcatName].length > 0) { 
                         const targetCol = leftSkills.includes(subcatName) ? leftCol : rightCol;
                         const groupDiv = document.createElement('div');
                         groupDiv.className = 'skill-group';
                         
                        const subcatHeader = document.createElement('h5');
                        subcatHeader.className = 'skill-subcategory-header';
                        subcatHeader.textContent = subcatName;
                        groupDiv.appendChild(subcatHeader);
                        
                        metafocusData[subcatName].forEach(skillName => {
                            const skillId = `metafocus-${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                            groupDiv.appendChild(createSkillRow(skillName, skillId));
                        });
                        targetCol.appendChild(groupDiv);
                    }
                }
                columnsDiv.appendChild(leftCol);
                columnsDiv.appendChild(rightCol);
                container.appendChild(columnsDiv);
            }


            function populateFolio2() {
                const traitsContainerLeft = document.getElementById('traits-list-left');
                const traitsContainerRight = document.getElementById('traits-list-right');
                
                traitsContainerLeft.innerHTML = '';
                traitsContainerRight.innerHTML = '';


                const createTraitGrid = (traitType) => {
                    const traitGrid = document.createElement('div');
                    traitGrid.className = 'trait-grid';
                    traitGrid.dataset.traitType = traitType.toLowerCase();
                    traitGrid.innerHTML = `<h5>${traitType}</h5><div class="grid-header">Trait</div><div class="grid-header">Effect</div>`;
                    addTraitRow(traitGrid, traitType.toLowerCase());
                    return traitGrid;
                }

                if (!traitsContainerLeft || !traitsContainerRight) return;
                
                ['Species', 'Origin'].forEach(traitType => {
                    traitsContainerLeft.appendChild(createTraitGrid(traitType));
                });
                
                ['Occupation', 'Faction'].forEach(traitType => {
                     traitsContainerRight.appendChild(createTraitGrid(traitType));
                });

                // Clear and repopulate simple/single grids
                ['invocations-list', 'augmentations-list', 'features-list', 'other-traits-list', 'disadvantages-list', 'special-abilities-list'].forEach(id => {
                    const el = document.getElementById(id);
                    // Clear all but header rows/elements
                    while(el.children.length > (el.classList.contains('simple-grid') ? 2 : (el.id === 'special-abilities-list' ? 0 : 1))) {
                        el.removeChild(el.lastChild);
                    }
                });

                addSimpleGridRow(document.getElementById('invocations-list'));
                addSimpleGridRow(document.getElementById('augmentations-list'));
                addSimpleGridRow(document.getElementById('features-list'));
                addSingleColumnRow(document.getElementById('other-traits-list'));
                addSingleColumnRow(document.getElementById('disadvantages-list'));
                addSpecialAbilityRow(document.getElementById('special-abilities-list'));
            }
             function populateFolio3() {
                ['mecha-list', 'gear-list', 'miscellaneous-list'].forEach(id => {
                    const el = document.getElementById(id);
                    while(el.children.length > 1) { el.removeChild(el.lastChild); }
                });
                addSingleColumnRow(document.getElementById('mecha-list'));
                addSingleColumnRow(document.getElementById('gear-list'));
                addSingleColumnRow(document.getElementById('miscellaneous-list'));
            }
            
            function populateFolio4() {
                 const el = document.getElementById('notes-list');
                 while(el.children.length > 0) { el.removeChild(el.lastChild); } // No header here
                addSingleColumnRow(document.getElementById('notes-list'));
            }

            function addAttackRow() {
                 const container = document.getElementById('attack-rows');
                 const index = container.querySelectorAll('[data-dynamic-row]').length / 4;
                 const row = document.createElement('div');
                 row.style.display = 'contents'; 
                 row.innerHTML = `<input type="text" id="attack-name-${index}" aria-label="Attack ${index} Name" class="attack-name" data-dynamic-row="true"><input type="text" id="attack-score-${index}" aria-label="Attack ${index} Score" class="attack-score" data-dynamic-row="true"><input type="text" id="attack-damage-${index}" aria-label="Attack ${index} Damage" class="attack-damage" data-dynamic-row="true"><input type="text" id="attack-notes-${index}" aria-label="Attack ${index} Notes" class="attack-notes" data-dynamic-row="true">`;
                 container.appendChild(row);
            }

            const calculateSkillTotal = (skillRow) => {
                const rank = parseInt(skillRow.querySelector('.skill-rank')?.value) || 0;
                const mod = parseInt(skillRow.querySelector('.skill-mod')?.value) || 0;
                const totalInput = skillRow.querySelector('.skill-total');
                const selectElement = skillRow.querySelector('.skill-base-select');
                let baseValue = 0;
                if (selectElement) {
                    const selectedAttributeId = selectElement.value;
                    if (selectedAttributeId) {
                        const attributeInput = document.getElementById(selectedAttributeId);
                        if (attributeInput) {
                            baseValue = parseInt(attributeInput.value) || 0;
                        }
                    }
                }
                if (totalInput) {
                    totalInput.value = rank + baseValue + mod;
                }
            };

            function handleDynamicRowCreation(event) {
                const target = event.target;
                if (!target.dataset.dynamicRow) return;

                const traitGrid = target.closest('.trait-grid');
                if (traitGrid) {
                    const inputs = Array.from(traitGrid.querySelectorAll('[data-dynamic-row]'));
                    if (inputs.indexOf(target) >= inputs.length - 2) {
                        addTraitRow(traitGrid, traitGrid.dataset.traitType);
                    }
                    return;
                }

                const simpleGrid = target.closest('.simple-grid');
                if(simpleGrid) {
                    const inputs = Array.from(simpleGrid.querySelectorAll('[data-dynamic-row]'));
                    if (inputs.indexOf(target) >= inputs.length - 2) {
                       addSimpleGridRow(simpleGrid);
                    }
                    return;
                }

                 const singleGrid = target.closest('.single-column-grid');
                 if(singleGrid) {
                    const inputs = Array.from(singleGrid.querySelectorAll('[data-dynamic-row]'));
                      if (target === inputs[inputs.length - 1]) {
                         addSingleColumnRow(singleGrid);
                    }
                    return;
                 }


                const specialList = target.closest('#special-abilities-list');
                if(specialList) {
                    const inputs = Array.from(specialList.querySelectorAll('[data-dynamic-row]'));
                    if(inputs.indexOf(target) >= inputs.length - 5) { // 5 inputs per row
                          addSpecialAbilityRow(specialList);
                    }
                      return;
                }
                
                const attackGrid = target.closest('#attack-rows');
                if(attackGrid) {
                    const inputs = Array.from(attackGrid.querySelectorAll('[data-dynamic-row]'));
                    if(inputs.indexOf(target) >= inputs.length - 4) {
                        addAttackRow();
                    }
                }
            }

            sheet.addEventListener('input', (event) => {
                if (event.target.matches('.skill-rank, .skill-mod, .attribute-input')) {
                     const skillRow = event.target.closest('.skill-row');
                    if (skillRow) {
                        calculateSkillTotal(skillRow);
                    }
                    if (event.target.matches('.attribute-input')) {
                        const changedAttributeId = event.target.id;
                        document.querySelectorAll('.skill-base-select').forEach(select => {
                            if (select.value === changedAttributeId) {
                                calculateSkillTotal(select.closest('.skill-row'));
                            }
                        });
                    }
                }
                handleDynamicRowCreation(event);
            });

            sheet.addEventListener('change', (event) => {
                if (event.target.matches('.skill-base-select')) {
                    calculateSkillTotal(event.target.closest('.skill-row'));
                }
            });

            // --- IMPORT/EXPORT FUNCTIONS ---
            const getInputValue = (id) => document.getElementById(id)?.value || '';
            const downloadFile = (filename, content, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const saveAsJson = () => {
                const data = {};
                const inputs = sheet.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.id) {
                        data[input.id] = input.value;
                    }
                });
                const charName = getInputValue('char-name').replace(/\s+/g, '_') || 'tangent-character';
                downloadFile(`${charName}.json`, JSON.stringify(data, null, 2), 'application/json');
            };

            const loadFromJson = (data) => {
                 // Reset the sheet to a clean slate before loading
                populateFolio1();
                populateFolio2();
                populateFolio3();
                populateFolio4();

                const dynamicCounts = {};
                const idPrefixes = ['trait-species-trait-', 'trait-origin-trait-', 'trait-occupation-trait-', 'trait-faction-trait-', 'attack-name-', 'features-name-', 'invocations-name-', 'augmentations-name-', 'modifiers-name-', 'disadvantages-name-', 'other-traits-name-', 'gear-name-', 'mecha-name-', 'miscellaneous-name-', 'notes-name-', 'skill-special-name-'];

                for(const id in data) {
                    for(const prefix of idPrefixes) {
                        if(id.startsWith(prefix)) {
                            dynamicCounts[prefix] = (dynamicCounts[prefix] || 0) + 1;
                        }
                    }
                }
                
                // Add necessary rows for each dynamic section
                for(const prefix in dynamicCounts) {
                    const count = dynamicCounts[prefix];
                    for(let i=0; i < count - 1; i++){ // -1 because one row exists by default
                        if(prefix.startsWith('trait-')) {
                            const type = prefix.split('-')[1];
                            const container = document.getElementById(`traits-list-${type.startsWith('s') || type.startsWith('o') ? 'left' : 'right'}`);
                            const grid = container.querySelector(`[data-trait-type="${type}"]`);
                            if (grid) addTraitRow(grid, type);
                        } else if(prefix === 'attack-name-') {
                            addAttackRow();
                        } else if (['features-name-', 'invocations-name-', 'augmentations-name-'].includes(prefix)) {
                            addSimpleGridRow(document.getElementById(prefix.replace('-name-', '-list')));
                        } else if (prefix === 'skill-special-name-') {
                            addSpecialAbilityRow(document.getElementById('special-abilities-list'));
                        } else {
                            addSingleColumnRow(document.getElementById(prefix.replace('-name-', '-list')));
                        }
                    }
                }


                // Now populate all fields
                for (const id in data) {
                    const element = document.getElementById(id);
                    if (element) {
                        // For selects, ensure the option exists before setting
                        if (element.tagName === 'SELECT') {
                            if ([...element.options].some(opt => opt.value === data[id])) {
                                element.value = data[id];
                            }
                        } else {
                            element.value = data[id];
                        }
                    }
                }
                
                // Recalculate all skill totals after loading
                document.querySelectorAll('.skill-row[data-skill-id]').forEach(calculateSkillTotal);
            };

            const saveAsPdf = () => {
                const charName = getInputValue('char-name');

                const getPdfBio = () => {
                    const bioFields = [
                        ['Name', getInputValue('char-name'), 'Concept', getInputValue('char-concept')],
                        ['Species', getInputValue('char-species'), 'Occupation', getInputValue('char-occu')],
                        ['Origin', getInputValue('char-origin'), 'Faction', getInputValue('char-faction')],
                        ['Age', getInputValue('char-age'), 'Gender', getInputValue('char-gender')],
                        ['Height', getInputValue('char-height'), 'Weight', getInputValue('char-weight')]
                    ];

                    const bioTable = {
                        table: {
                            widths: ['auto', '*', 'auto', '*'],
                            body: bioFields.map(row => [
                                { text: row[0] + ':', style: 'label' }, { text: row[1], style: 'value' },
                                { text: row[2] + ':', style: 'label' }, { text: row[3], style: 'value' }
                            ])
                        },
                        layout: 'noBorders',
                        marginBottom: 10
                    };

                    const description = { text: [ { text: 'Description: ', style: 'label' }, { text: getInputValue('char-style'), style: 'value' } ], marginBottom: 5 };
                    const motive = { text: [ { text: 'Motive: ', style: 'label' }, { text: getInputValue('char-motive'), style: 'value' } ], marginBottom: 15 };

                    return [bioTable, description, motive];
                };
                
                const getPdfAttributesAndStats = () => {
                    const attributesBody = [
                        [{text: 'Primary Attributes', style: 'h3', colSpan: 4, alignment: 'left', border: [false, false, false, true]}, {}, {}, {}]
                    ];
                    const attrRows = [
                        ['Strength', 'attr-strength', 'Might', 'attr-might'],
                        ['Agility', 'attr-agility', 'Reflex', 'attr-reflex'],
                        ['Constitution', 'attr-constitution', 'Fortitude', 'attr-fortitude'],
                        ['Intellect', 'attr-intellect', 'Logic', 'attr-logic'],
                        ['Wisdom', 'attr-wisdom', 'Will', 'attr-will'],
                        ['Charisma', 'attr-charisma', 'Etiquette', 'attr-etiquette']
                    ];
                    attrRows.forEach(row => {
                         attributesBody.push([
                            {text: row[0], style:'label', fontSize: 11, bold: true}, getInputValue(row[1]),
                            {text: row[2], style:'label', italics: true}, getInputValue(row[3])
                         ]);
                    });

                    const statsBody = [
                        [{text: 'Core Stats', style: 'h3', colSpan: 2, alignment: 'left', border: [false, false, false, true]}, {}],
                        [{text: 'Health:', style:'label'}, getInputValue('health')],
                        [{text: 'Vitality:', style:'label'}, getInputValue('vitality')],
                        [{text: 'Initiative:', style:'label'}, getInputValue('initiative')],
                    ];

                     return {
                        columns: [
                            { width: '60%', table: { widths: ['auto', '*', 'auto', '*'], body: attributesBody }, layout: 'noBorders'},
                            { width: '40%', table: { widths: ['auto', '*'], body: statsBody }, layout: 'noBorders' }
                        ],
                        columnGap: 10,
                        marginBottom: 15
                     };
                };

                const getPdfSkillTables = (containerId) => {
                    const tables = [];
                    const container = document.getElementById(containerId);
                    if (!container) return tables;

                    container.querySelectorAll('.skill-group').forEach(group => {
                        const groupBody = [];
                        const groupNameEl = group.querySelector('.skill-group-header, .skill-subcategory-header');
                        if (!groupNameEl) return;
                        
                        const groupName = groupNameEl.textContent;
                        const headerStyle = group.querySelector('.skill-group-header') ? 'groupHeader' : 'subgroupHeader';
                        groupBody.push([{ text: groupName.trim(), colSpan: 5, style: headerStyle}, {}, {}, {}, {}]);

                        
                        group.querySelectorAll('.skill-row[data-skill-id]').forEach(element => {
                           if (element.classList.contains('skill-row') && element.dataset.skillId) {
                                let label = (element.querySelector('.skill-name-input') || element.querySelector('label')).value || (element.querySelector('.skill-name-input') || element.querySelector('label')).textContent;
                                const rank = element.querySelector('.skill-rank').value;
                                const baseSelect = element.querySelector('.skill-base-select');
                                const base = baseSelect.options[baseSelect.selectedIndex]?.text || '';
                                const mod = element.querySelector('.skill-mod').value;
                                const total = element.querySelector('.skill-total').value;
                                if (label || rank || base !== '--' || mod) {
                                    groupBody.push([label, rank, base, mod, {text: total, bold: true}]);
                                }
                            }
                        });
                        
                        if(groupBody.length > 1) { // Only add table if there are skills in it
                            tables.push({
                                table: {
                                    widths: ['*', 'auto', 'auto', 'auto', 'auto'],
                                    body: groupBody,
                                    dontBreakRows: true
                                },
                                 layout: 'lightHorizontalLines',
                                 marginBottom: 10
                            });
                        }
                    });
                    return tables;
                };

                // UPDATED: Logic to handle empty Metafocus section
                const getMetafocusPdfContent = () => {
                    const content = [];
                    
                    const attuneRow = document.querySelector('.skill-row[data-skill-id="metafocus-attune"]');
                    if (attuneRow) {
                         const rank = attuneRow.querySelector('.skill-rank').value;
                         const total = attuneRow.querySelector('.skill-total').value;
                         if(rank || (total && parseInt(total) !== 0)) {
                            content.push({
                                table: {
                                    widths: ['*', 'auto', 'auto', 'auto', 'auto'],
                                    body: [
                                        [{text: 'Attune', style: 'groupHeader', colSpan: 5}, {}, {}, {}, {}],
                                        ['Attune', rank, attuneRow.querySelector('.skill-base-select').options[attuneRow.querySelector('.skill-base-select').selectedIndex]?.text || '', attuneRow.querySelector('.skill-mod').value, {text: total, bold: true}]
                                    ]
                                },
                                layout: 'lightHorizontalLines',
                                marginBottom: 10
                            });
                         }
                    }

                    const leftColStack = getPdfSkillTables('metafocus-skills-list-left');
                    const rightColStack = getPdfSkillTables('metafocus-skills-list-right');
                    
                    if (leftColStack.length > 0 || rightColStack.length > 0) {
                         content.push({
                            columns: [
                                { width: '50%', stack: leftColStack },
                                { width: '50%', stack: rightColStack }
                            ],
                            columnGap: 10
                        });
                    }
                    
                    // If after all checks, content is empty, add a blank table to ensure the header has a line under it.
                    if (content.length === 0) {
                        content.push({
                            table: { widths: ['*'], body: [[' ']] },
                            layout: 'lightHorizontalLines'
                        });
                    }

                    return content;
                };
                
                const getSimpleGridBody = (containerId, headers) => {
                    const body = [headers.map(h => ({text: h, style: 'tableHeader'}))];
                    const container = document.getElementById(containerId);
                    if (!container) return body;
                    const inputs = container.querySelectorAll('input[type=text], input[type=number]');
                    const numCols = headers.length;
                    for (let i = 0; i < inputs.length; i += numCols) {
                        const row = [];
                        for (let j = 0; j < numCols; j++) {
                            row.push(inputs[i+j]?.value || '');
                        }
                        if (row.some(cell => cell)) {
                             body.push(row);
                        }
                    }
                    if (body.length === 1) { body.push(new Array(headers.length).fill('')); }
                    return body;
                };

                const getSingleColumnBody = (containerId, header) => {
                    const body = [[{text: header, style: 'tableHeader'}]];
                     const container = document.getElementById(containerId);
                    if (!container) return body;
                    const inputs = container.querySelectorAll('input[type=text]');
                    inputs.forEach(input => {
                        if (input.value) { body.push([input.value]); }
                    });
                     if (body.length === 1) { body.push([' ']); }
                    return body;
                }
                
                const getAttackTableBody = () => getSimpleGridBody('attack-rows', ['Attack', 'Score', 'Damage', 'Notes']);
                const getInvocationsBody = () => getSimpleGridBody('invocations-list', ['Invocation', 'Level']);
                const getAugmentationsBody = () => getSimpleGridBody('augmentations-list', ['Augmentation', 'Effect']);
                const getFeaturesBody = () => getSimpleGridBody('features-list', ['Feature', 'Effect']);


                 const getArmorTableBody = () => {
                    const body = [[{ text: 'Location', style: 'tableHeader' }, { text: 'Total DR', style: 'tableHeader' }, { text: 'Notes', style: 'tableHeader' }]];
                      document.querySelectorAll('#armor-rows > label').forEach(label => {
                         const location = label.textContent;
                         const dr = document.getElementById(`${label.htmlFor}-dr`)?.value || '';
                         const notes = document.getElementById(`${label.htmlFor}-notes`)?.value || '';
                         body.push([location, dr, notes]);
                    });
                    return body;
                };

                const getTraitColumnStack = (traitTypes) => {
                    const stack = [];
                    traitTypes.forEach(traitType => {
                        const body = [];
                        const typeLowerCase = traitType.toLowerCase();
                        body.push([{text: traitType, style: 'h3', colSpan: 2, alignment: 'left', border: [false, false, false, true]}, {}]);
                        
                        const traitGrid = document.querySelector(`.trait-grid[data-trait-type="${typeLowerCase}"]`);
                        if(traitGrid) {
                             const inputs = traitGrid.querySelectorAll('input[type="text"]');
                            for (let i = 0; i < inputs.length; i += 2) {
                                const traitVal = inputs[i].value;
                                const effectVal = inputs[i+1].value;
                                if (traitVal || effectVal) {
                                    body.push([traitVal, effectVal]);
                                }
                            }
                        }
                        if(body.length === 1){ body.push(['','']); }
                        stack.push({
                            table: { widths:['35%', '65%'], body: body },
                            layout: 'noBorders',
                            marginBottom: 10
                        });
                    });
                    return stack;
                };

                const docDefinition = {
                    pageSize: 'LETTER',
                    pageMargins: [ 25, 40, 25, 40 ],
                    content: [
                        // Page 1 (Cover Sheet)
                        { text: 'TANGENT', style: 'h1', alignment: 'center' },
                        { text: 'SCI-FI FANTASY RPG', style: 'h2', alignment: 'center', margin: [0, 0, 0, 15] },
                        ...getPdfBio(),
                        getPdfAttributesAndStats(),
                        { text: 'Attack', style: 'h3', margin: [0, 15, 0, 5]},
                        { table: { widths: ['*', 50, 50, '*'], body: getAttackTableBody() }, layout: 'lightHorizontalLines' },
                        { text: 'Armor', style: 'h3', margin: [0, 15, 0, 5]},
                        { table: { widths: [100, 100, '*'], body: getArmorTableBody() }, layout: 'lightHorizontalLines' },
                        
                        // Page 2 (Skills)
                        { text: '', pageBreak: 'before' },
                        {
                            columns: [
                                { width: '50%', stack: getPdfSkillTables('skills-list-left') },
                                { width: '50%', stack: getPdfSkillTables('skills-list-right') }
                            ],
                            columnGap: 10
                        },
                        
                        // Page 3 (Traits, etc)
                        { text: '', pageBreak: 'before' },
                         {
                            columns: [
                                { width: '50%', stack: getTraitColumnStack(['Species', 'Origin']) },
                                { width: '50%', stack: getTraitColumnStack(['Occupation', 'Faction']) }
                            ],
                            columnGap: 10
                        },
                        {text: 'Other Traits', style: 'h3', margin: [0, 15, 0, 5]},
                        {table: { widths: ['*'], body: getSingleColumnBody('other-traits-list', 'Other Trait') }, layout:'lightHorizontalLines', marginBottom: 15},
                        {text: 'Augmentations', style: 'h3', margin: [0, 15, 0, 5]},
                        {table: { widths: ['*', '*'], body: getAugmentationsBody()}, layout:'lightHorizontalLines', marginBottom: 15},
                        {text: 'Features', style: 'h3', margin: [0, 15, 0, 5]},
                        {table: { widths: ['*', '*'], body: getFeaturesBody()}, layout:'lightHorizontalLines', marginBottom: 15},
                        {text: 'Disadvantages', style: 'h3', margin: [0, 15, 0, 5]},
                        {table: { widths: ['*'], body: getSingleColumnBody('disadvantages-list', 'Disadvantage') }, layout:'lightHorizontalLines', marginBottom: 15},
                        { text: 'Metafocus', style: 'h3', margin: [0,15,0,5] },
                        ...getMetafocusPdfContent(),
                        
                        // Page 4 (Gear)
                        { text: '', pageBreak: 'before' },
                        {text: 'Gear', style: 'h3', margin: [0, 15, 0, 5]},
                        {table: { widths: ['*'], body: getSingleColumnBody('gear-list', 'Gear') }, layout:'lightHorizontalLines', marginBottom: 15},
                        {text: 'Mecha', style: 'h3', margin: [0, 15, 0, 5]},
                        {table: { widths: ['*'], body: getSingleColumnBody('mecha-list', 'Mecha') }, layout:'lightHorizontalLines', marginBottom: 15},
                        {text: 'Miscellaneous', style: 'h3', margin: [0, 15, 0, 5]},
                        {table: { widths: ['*'], body: getSingleColumnBody('miscellaneous-list', 'Item') }, layout:'lightHorizontalLines', marginBottom: 15},
                        
                        // Page 5 (Notes)
                        { text: '', pageBreak: 'before' },
                         {text: 'Notes', style: 'h3', margin: [0, 15, 0, 5]},
                         {table: { widths: ['*'], body: getSingleColumnBody('notes-list', 'Note') }, layout:'lightHorizontalLines', marginBottom: 15}
                    ],
                    footer: function(currentPage, pageCount) { 
                        if (currentPage === pageCount) {
                            return { 
                                text: 'WOLFE.BT@TANGENTLLC',
                                alignment: 'center',
                                style: 'footer'
                            }; 
                        }
                        return null;
                    },
                    styles: {
                        h1: { font: 'Roboto', fontSize: 24, bold: true },
                        h2: { font: 'Roboto', fontSize: 10, color: '#495057' },
                        h3: { font: 'Roboto', fontSize: 14, bold: true, textTransform: 'uppercase' },
                        label: { bold: true, color: '#333333' },
                        value: { italics: true, color: '#555' },
                        attrValue: { alignment: 'right', bold: true, fontSize: 14 },
                        tableHeader: { bold: true, fontSize: 9, color: 'black', fillColor: '#e9ecef', alignment: 'center' },
                        groupHeader: { bold: true, fontSize: 11, color: 'black', margin: [0, 5, 0, 5], fillColor: '#e9ecef'},
                        subgroupHeader: { bold: true, italics: true, fontSize: 9, color: '#333333', margin: [10, 2, 0, 2]},
                        textarea: { margin: [0, 5, 0, 5], italics: true, color: '#555', fontSize: 9 },
                        footer: { fontSize: 8, color: '#616161', margin: [0, 10, 0, 0]}
                    },
                    defaultStyle: { font: 'Roboto', fontSize: 9 }
                };
                
                pdfMake.createPdf(docDefinition).download(`${charName.replace(/\s/g, '_') || 'tangent-character'}.pdf`);
            };
            
            const saveAsMarkdown = () => {
                let md = `# Tangent SFF RPG Persona Folio\n\n`;
                const charName = getInputValue('char-name');
                if (charName) md += `## ${charName}\n\n`;

                const getMdSection = (title, fields) => {
                    let sectionMd = `### ${title}\n\n`;
                    fields.forEach(f => {
                        const val = getInputValue(f.id);
                        if(val) sectionMd += `- **${f.label}:** ${val}\n`;
                    });
                    return sectionMd + '\n';
                }

                const getMdGrid = (title, gridId, headers) => {
                     let sectionMd = `### ${title}\n\n`;
                     sectionMd += `| ${headers.join(' | ')} |\n`;
                     sectionMd += `| ${headers.map(() => '---').join(' | ')} |\n`;
                     
                     const container = document.getElementById(gridId);
                     const inputs = container.querySelectorAll('input[type=text], input[type=number]');
                     const numCols = headers.length;
                     for (let i = 0; i < inputs.length; i += numCols) {
                         const rowValues = [];
                         for(let j=0; j<numCols; j++) {
                             rowValues.push(inputs[i+j]?.value || ' ');
                         }
                         if (rowValues.some(cell => cell.trim())) {
                             sectionMd += `| ${rowValues.join(' | ')} |\n`;
                         }
                     }
                     return sectionMd + '\n';
                }
                
                 const getMdSingleColumnGrid = (title, gridId) => {
                     let sectionMd = `### ${title}\n\n`;
                     const container = document.getElementById(gridId);
                     const inputs = container.querySelectorAll('input[type=text]');
                     inputs.forEach(input => {
                         if(input.value) sectionMd += `- ${input.value}\n`;
                     });
                     return sectionMd + '\n';
                 }

                // Bio
                md += getMdSection('Character Information', [
                    {id: 'char-concept', label: 'Concept'}, {id: 'char-species', label: 'Species'},
                    {id: 'char-occu', label: 'Occupation'}, {id: 'char-origin', label: 'Origin'},
                    {id: 'char-faction', label: 'Faction'}, {id: 'char-age', label: 'Age'},
                    {id: 'char-gender', label: 'Gender'}, {id: 'char-height', label: 'Height'},
                    {id: 'char-weight', label: 'Weight'}, {id: 'char-style', label: 'Description'},
                    {id: 'char-motive', label: 'Motive'}
                ]);

                // Attributes and Stats
                md += `### Attributes & Stats\n\n`
                md += `| Attribute | Value | Secondary | Value |\n`
                md += `| :--- | :--- | :--- | :--- |\n`
                md += `| Strength | ${getInputValue('attr-strength')} | Might | ${getInputValue('attr-might')} |\n`
                md += `| Agility | ${getInputValue('attr-agility')} | Reflex | ${getInputValue('attr-reflex')} |\n`
                md += `| Constitution | ${getInputValue('attr-constitution')} | Fortitude | ${getInputValue('attr-fortitude')} |\n`
                md += `| Intellect | ${getInputValue('attr-intellect')} | Logic | ${getInputValue('attr-logic')} |\n`
                md += `| Wisdom | ${getInputValue('attr-wisdom')} | Will | ${getInputValue('attr-will')} |\n`
                md += `| Charisma | ${getInputValue('attr-charisma')} | Etiquette | ${getInputValue('attr-etiquette')} |\n\n`
                md += `- **Health:** ${getInputValue('health')} | **Vitality:** ${getInputValue('vitality')} | **Initiative:** ${getInputValue('initiative')}\n\n`;

                // Skills
                md += `### Skills\n\n| Skill | Rank | Base | Mod | Total |\n|---|---|---|---|---|\n`;
                document.querySelectorAll('.skill-row[data-skill-id]').forEach(row => {
                    const labelEl = row.querySelector('label') || row.querySelector('.skill-name-input');
                    const label = labelEl.tagName === 'LABEL' ? labelEl.textContent : labelEl.value;
                    const rank = row.querySelector('.skill-rank').value;
                    const baseSelect = row.querySelector('.skill-base-select');
                    const base = baseSelect.options[baseSelect.selectedIndex]?.text || '--';
                    const mod = row.querySelector('.skill-mod').value;
                    const total = row.querySelector('.skill-total').value;
                    if (label || rank || mod || total) {
                        md += `| ${label} | ${rank || 0} | ${base} | ${mod || 0} | **${total || 0}** |\n`;
                    }
                });
                md += '\n';

                // Combat and Traits
                md += getMdGrid('Attacks', 'attack-rows', ['Attack', 'Score', 'Damage', 'Notes']);
                md += getMdGrid('Features', 'features-list', ['Feature', 'Effect']);
                md += getMdSingleColumnGrid('Disadvantages', 'disadvantages-list');
                md += getMdGrid('Augmentations', 'augmentations-list', ['Augmentation', 'Effect']);

                // Gear
                md += getMdSingleColumnGrid('Gear', 'gear-list');
                md += getMdSingleColumnGrid('Miscellaneous', 'miscellaneous-list');
                
                downloadFile(`${charName.replace(/\s/g, '_') || 'tangent-character'}.md`, md, 'text/markdown');
            };
            
            pdfMake.fonts = {
                Roboto: {
                    normal: 'Roboto-Regular.ttf',
                    bold: 'Roboto-Medium.ttf',
                    italics: 'Roboto-Italic.ttf',
                    bolditalics: 'Roboto-MediumItalic.ttf'
                }
            };
            
            // File Menu Logic
            const fileMenuButton = document.querySelector('.file-menu-button');
            const fileMenuDropdown = document.querySelector('.file-menu-dropdown');
            const loadJsonInput = document.getElementById('load-json-input');

            document.getElementById('save-json-btn').addEventListener('click', saveAsJson);
            document.getElementById('load-json-btn').addEventListener('click', () => loadJsonInput.click());
            document.getElementById('save-pdf-btn').addEventListener('click', saveAsPdf);
            document.getElementById('save-md-btn').addEventListener('click', saveAsMarkdown);

            loadJsonInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadFromJson(data);
                    } catch (error) {
                        console.error("Error parsing JSON file:", error);
                        // Using a more robust notification than alert()
                        const notice = document.createElement('div');
                        notice.textContent = 'Error: Could not load character sheet. The file may be invalid.';
                        notice.style.position = 'fixed';
                        notice.style.top = '20px';
                        notice.style.left = '50%';
                        notice.style.transform = 'translateX(-50%)';
                        notice.style.padding = '1rem';
                        notice.style.backgroundColor = '#d9534f';
                        notice.style.color = 'white';
                        notice.style.borderRadius = '5px';
                        notice.style.zIndex = '1000';
                        document.body.appendChild(notice);
                        setTimeout(() => document.body.removeChild(notice), 4000);
                    }
                };
                reader.readAsText(file);
                loadJsonInput.value = ''; // Reset input so the same file can be loaded again
            });

            fileMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                fileMenuDropdown.classList.toggle('show');
            });

            window.addEventListener('click', (event) => {
                if (!fileMenuButton.contains(event.target)) {
                    fileMenuDropdown.classList.remove('show');
                }
            });

            // Initial Population
            populateSkillContainer('skills-list-left', mentalSkillData);
            populateSkillContainer('skills-list-right', otherSkillData);
            populateMetafocus();
            populateFolio1();
            populateFolio2();
            populateFolio3();
            populateFolio4();

            document.querySelectorAll('.skill-row[data-skill-id]').forEach(calculateSkillTotal);
        });
    </script>
</body>
</html>
