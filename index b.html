<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tangent SFF RPG Persona Folio</title>
    <!-- Google Fonts for the web page styling -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- pdfmake library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- pdfmake requires a virtual file system for fonts. The default CDN only includes Roboto. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* style.css content is now embedded in the HTML file for simplicity */
        :root {
            /* New darker greyscale palette for high contrast */
            --bg-color: #212121; /* Dark page background */
            --section-bg: #424242; /* Lighter grey for sections */
            --text-color: #f5f5f5; /* Light grey text */
            --border-color: #9e9e9e; /* Lighter grey for borders */
            --subtle-border: #616161; /* Darker grey for internal lines */
            --header-bg: #333333; 
            --header-text: #eeeeee; 
            --input-bg: #616161; /* Mid-grey for inputs */
            --input-text: #ffffff;
            --font-body: 'Roboto Condensed', sans-serif; 
            --font-display: 'Roboto', sans-serif;
            --spacing-xs: 0.25rem; --spacing-sm: 0.5rem; --spacing-md: 1rem; --spacing-lg: 1.5rem;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: var(--spacing-md); 
        }
        .export-controls { 
            max-width: 1200px; 
            margin: 0 auto var(--spacing-md) auto; 
            padding: var(--spacing-sm); 
            background-color: var(--section-bg); 
            border: 2px solid var(--border-color); 
            border-radius: 8px;
            text-align: center; 
        }
        .export-controls button { 
            display: inline-block;
            width: 30%;
            font-family: var(--font-body); 
            font-weight: bold; 
            font-size: 0.9rem; 
            padding: 0.75rem var(--spacing-md); 
            margin: var(--spacing-xs) var(--spacing-sm); 
            border: 2px solid var(--header-text); 
            border-radius: 5px;
            background-color: var(--header-bg); 
            color: #ffffff; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; 
            text-shadow: 1px 1px 2px #000; /* Adds a dark "border" to the text */
        }
        .export-controls button:hover { 
            background-color: #eeeeee; 
            color: #212121;
            border-color: #eeeeee; 
            text-shadow: none;
        }
        .character-sheet { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-lg); 
        }
        .main-section { 
            border: 2px solid var(--border-color); 
            padding: var(--spacing-lg); 
            background-color: var(--section-bg); 
            border-radius: 8px;
        }
        .sheet-header { 
            text-align: center; 
            font-family: var(--font-display); 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: var(--spacing-lg); 
            padding-bottom: var(--spacing-md); 
        }
        .sheet-header h1 { margin: 0; color: var(--text-color); }
        .creator-credit {
            text-align: center;
            margin-top: var(--spacing-lg);
            font-size: 0.8rem;
            color: var(--header-text);
            font-family: var(--font-display);
            letter-spacing: 2px;
        }
        .columns-2 { display: flex; gap: var(--spacing-lg); }
        .columns-2 > .col-left { flex: 2; }
        .columns-2 > .col-right { flex: 1; }
        .columns-2.equal-width > * {
            flex: 1;
        }
        fieldset { 
            border: 2px solid var(--border-color); 
            border-radius: 4px;
            padding: var(--spacing-md); 
            margin: 0 0 var(--spacing-lg) 0; 
        }
        fieldset:last-child { margin-bottom: 0; }
        legend { 
            font-weight: bold; 
            padding: 0 var(--spacing-sm); 
            font-family: var(--font-display); 
            text-transform: uppercase; 
        }
        .input-group { display: flex; flex-direction: column; }
        .input-group.full-width { grid-column: 1 / -1; }
        label { margin-bottom: var(--spacing-xs); font-size: 0.875rem; font-weight: bold; color: var(--header-text); }
        input[type="text"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: var(--spacing-sm); 
            border: 1.5px solid var(--border-color); 
            border-radius: 4px;
            background-color: var(--input-bg); 
            color: var(--input-text);
            font-family: var(--font-body); 
            font-size: 1rem; 
        }
        textarea { resize: vertical; }

        /* Grid Layouts */
        .bio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md) var(--spacing-lg);
        }
        .vitals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md); }
        .attributes-container { display: flex; gap: var(--spacing-md); }
        .attribute-column { flex: 1; display: flex; flex-direction: column; gap: var(--spacing-md); }
        .attribute-group { display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto; gap: 0 var(--spacing-sm); align-items: center; }
        .attribute-group label:nth-of-type(1) { grid-column: 1; grid-row: 1; }
        .attribute-group input:nth-of-type(1) { grid-column: 2; grid-row: 1; width: 60px; }
        .attribute-group label:nth-of-type(2) { grid-column: 1; grid-row: 2; font-size: 0.8rem; padding-left: var(--spacing-md); }
        .attribute-group input:nth-of-type(2) { grid-column: 2; grid-row: 2; width: 42px; }
        .attack-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 3fr; gap: var(--spacing-sm); align-items: center; }
        .armor-grid { display: grid; grid-template-columns: 1fr 1fr 4fr; gap: var(--spacing-sm) var(--spacing-md); align-items: center; }
        .armor-grid label { font-weight: bold; margin-bottom: 0; }
        .attack-header, .armor-header, .grid-header { font-weight: bold; font-size: 0.8rem; color: var(--header-text); border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); }

        .core-stats-container { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .ratings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
        .move-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-md); }
        .perception-grid { display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-xs) var(--spacing-sm); align-items: center;}
        .perception-grid > input:first-child { grid-column: 1 / -1; margin-bottom: var(--spacing-sm); }
        .perception-grid label { text-align: right; }


        /* Skills Section */
        .skills-column {
             display: flex;
             flex-direction: column;
             gap: var(--spacing-lg);
        }
        .skill-group { break-inside: avoid; }
        .skill-group-header { background-color: var(--header-bg); padding: var(--spacing-sm); margin: 0 0 var(--spacing-sm) 0; text-align: center; font-family: var(--font-display); text-transform: uppercase; border: 1.5px solid var(--subtle-border);}
        .skill-subcategory-header {
            font-family: var(--font-body);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            color: var(--header-text);
            padding-left: var(--spacing-sm);
            margin: var(--spacing-md) 0 var(--spacing-sm) 0;
            border-bottom: 1.5px solid var(--subtle-border);
        }
        .skill-row { display: grid; grid-template-columns: 2.5fr 1fr 1.5fr 1fr 1fr; gap: var(--spacing-sm); align-items: center; margin-bottom: var(--spacing-sm); }
        .skill-row.header { font-weight: bold; text-align: center; font-size: 0.8rem; color: var(--header-text); }
        .skill-row.header span { border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); }
        .skill-row label { font-weight: normal; margin-bottom: 0; color: var(--text-color); }
        .skill-row input, .skill-row select { text-align: center; padding: var(--spacing-xs); font-size: 0.9rem; }
        .skill-row input.skill-name-input {
            text-align: left;
            font-style: italic;
        }
        .skill-row .skill-total { background-color: var(--header-bg); font-weight: bold; }

        /* Folio 2 & 3 Specifics */
        .trait-grid { display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-sm) var(--spacing-md); }
        .trait-grid-container { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .trait-grid h5 { margin: 0; grid-column: 1 / -1; font-family: var(--font-display); text-transform: uppercase; border-bottom: 1.5px solid var(--subtle-border); padding-bottom: var(--spacing-xs); margin-bottom: var(--spacing-sm); }
        .trait-grid .grid-header { font-weight: bold; font-size: 0.8rem; color: var(--header-text); }
        .simple-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .single-column-grid { display: grid; grid-template-columns: 1fr; gap: var(--spacing-sm); }


        /* Responsive */
        @media (max-width: 768px) {
            .columns-2 { flex-direction: column; }
            .bio-grid { grid-template-columns: 1fr; }
            .vitals-grid, .ratings-grid, .move-grid { grid-template-columns: 1fr 1fr; }
            .attributes-container { flex-direction: column; }
            .skills-column { gap: 0; }
        }
    </style>
</head>
<body>

    <div class="export-controls">
        <button id="save-pdf-btn" type="button">Save as PDF</button>
        <button id="save-md-btn" type="button">Save as Markdown (.md)</button>
    </div>

    <form class="character-sheet">
        <header class="sheet-header">
            <h1>Tangent SFF RPG Persona Folio</h1>
        </header>
        
        <section class="main-section" id="bio-section">
            <fieldset><legend>Character Information</legend>
                <div class="bio-grid">
                    <div class="input-group"><label for="char-name">Name</label><input type="text" id="char-name" name="char-name"></div>
                    <div class="input-group"><label for="char-concept">Concept</label><input type="text" id="char-concept" name="char-concept"></div>
                    <div class="input-group"><label for="char-species">Species</label><input type="text" id="char-species" name="char-species"></div>
                    <div class="input-group"><label for="char-occu">Occupation</label><input type="text" id="char-occu" name="char-occu"></div>
                    <div class="input-group"><label for="char-origin">Origin</label><input type="text" id="char-origin" name="char-origin"></div>
                    <div class="input-group"><label for="char-faction">Faction</label><input type="text" id="char-faction" name="char-faction"></div>
                    <div class="input-group"><label for="char-age">Age</label><input type="text" id="char-age" name="char-age"></div>
                    <div class="input-group"><label for="char-gender">Gender</label><input type="text" id="char-gender" name="char-gender"></div>
                    <div class="input-group"><label for="char-height">Height</label><input type="text" id="char-height" name="char-height"></div>
                    <div class="input-group"><label for="char-weight">Weight</label><input type="text" id="char-weight" name="char-weight"></div>
                    <div class="input-group full-width"><label for="char-style">Description / Style</label><input type="text" id="char-style" name="char-style"></div>
                    <div class="input-group full-width"><label for="char-motive">Personality / Motive</label><input type="text" id="char-motive" name="char-motive"></div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="attributes-stats-section">
             <div class="columns-2">
                <div class="col-left">
                    <fieldset><legend>Primary Attributes</legend>
                        <div class="attributes-container">
                            <div class="attribute-column">
                                <div class="attribute-group"><label for="attr-strength">Strength</label><input type="number" id="attr-strength" class="attribute-input"><label for="attr-might">Might</label><input type="number" id="attr-might"></div>
                                <div class="attribute-group"><label for="attr-agility">Agility</label><input type="number" id="attr-agility" class="attribute-input"><label for="attr-reflex">Reflex</label><input type="number" id="attr-reflex"></div>
                                <div class="attribute-group"><label for="attr-constitution">Constitution</label><input type="number" id="attr-constitution" class="attribute-input"><label for="attr-fortitude">Fortitude</label><input type="number" id="attr-fortitude"></div>
                            </div>
                            <div class="attribute-column">
                                <div class="attribute-group"><label for="attr-intellect">Intellect</label><input type="number" id="attr-intellect" class="attribute-input"><label for="attr-logic">Logic</label><input type="number" id="attr-logic"></div>
                                <div class="attribute-group"><label for="attr-wisdom">Wisdom</label><input type="number" id="attr-wisdom" class="attribute-input"><label for="attr-will">Will</label><input type="number" id="attr-will"></div>
                                <div class="attribute-group"><label for="attr-charisma">Charisma</label><input type="number" id="attr-charisma" class="attribute-input"><label for="attr-etiquette">Etiquette</label><input type="number" id="attr-etiquette"></div>
                            </div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Modifiers</legend>
                        <div class="single-column-grid" id="modifiers-list">
                             <!-- Modifiers will be dynamically populated -->
                        </div>
                    </fieldset>
                </div>
                <div class="col-right">
                    <fieldset><legend>Core Stats</legend>
                        <div class="vitals-grid">
                            <div class="input-group"><label for="health">Health</label><input type="number" id="health"></div>
                            <div class="input-group"><label for="vitality">Vitality</label><input type="number" id="vitality"></div>
                            <div class="input-group"><label for="initiative">Initiative</label><input type="number" id="initiative"></div>
                        </div>
                    </fieldset>
                    <fieldset><legend>Ratings</legend>
                        <div class="ratings-grid">
                            <div class="input-group"><label for="karma">Karma</label><input type="number" id="karma"></div>
                            <div class="input-group"><label for="plot-points">Plot Points</label><input type="number" id="plot-points"></div>
                            <div class="input-group"><label for="tech-level">Tech Level</label><input type="text" id="tech-level"></div>
                            <div class="input-group"><label for="wealth">Wealth</label><input type="text" id="wealth"></div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Move</legend>
                        <div class="move-grid">
                            <div class="input-group"><label for="move-walk">Walk</label><input type="text" id="move-walk"></div>
                            <div class="input-group"><label for="move-swim">Swim</label><input type="text" id="move-swim"></div>
                            <div class="input-group"><label for="move-climb">Climb</label><input type="text" id="move-climb"></div>
                            <div class="input-group"><label for="move-fly">Fly</label><input type="text" id="move-fly"></div>
                        </div>
                    </fieldset>
                     <fieldset><legend>Perception</legend>
                        <div class="perception-grid">
                            <input type="number" id="perception">
                            <label for="perception-meta">Meta</label><input type="number" id="perception-meta">
                            <label for="perception-social">Social</label><input type="number" id="perception-social">
                            <label for="perception-tech">Technology</label><input type="number" id="perception-tech">
                        </div>
                    </fieldset>
                </div>
            </div>
        </section>

        <section class="main-section" id="skills-section">
            <fieldset><legend>Skills</legend>
                <div class="columns-2 equal-width">
                    <div id="skills-list-left" class="skills-column">
                        <!-- Mental skills will be dynamically populated by JavaScript -->
                    </div>
                    <div id="skills-list-right" class="skills-column">
                        <!-- Other skills will be dynamically populated by JavaScript -->
                    </div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="combat-section">
             <fieldset><legend>Attack</legend>
                <div class="attack-grid" id="attack-rows">
                    <div class="attack-header">Attack</div><div class="attack-header">Score</div><div class="attack-header">Damage</div><div class="attack-header">Notes</div>
                    <!-- Attack rows will be populated by JS -->
                </div>
            </fieldset>
            
            <fieldset><legend>Armor Location</legend>
                <div class="armor-grid" id="armor-rows">
                    <div class="armor-header">Location</div><div class="armor-header">Total DR</div><div class="armor-header">Notes</div>
                    <label for="armor-head">Head</label><input type="text" id="armor-head-dr"><input type="text" id="armor-head-notes">
                    <label for="armor-torso">Torso</label><input type="text" id="armor-torso-dr"><input type="text" id="armor-torso-notes">
                    <label for="armor-right-arm">Right Arm</label><input type="text" id="armor-right-arm-dr"><input type="text" id="armor-right-arm-notes">
                    <label for="armor-left-arm">Left Arm</label><input type="text" id="armor-left-arm-dr"><input type="text" id="armor-left-arm-notes">
                    <label for="armor-right-leg">Right Leg</label><input type="text" id="armor-right-leg-dr"><input type="text" id="armor-right-leg-notes">
                    <label for="armor-left-leg">Left Leg</label><input type="text" id="armor-left-leg-dr"><input type="text" id="armor-left-leg-notes">
                </div>
            </fieldset>
        </section>
        
        <section class="main-section" id="folio-2">
            <fieldset><legend>Traits</legend>
                <div class="columns-2 equal-width">
                    <div id="traits-list-left" class="trait-grid-container"></div>
                    <div id="traits-list-right" class="trait-grid-container"></div>
                </div>
            </fieldset>
        </section>
        
        <section class="main-section" id="features-and-traits-section">
             <fieldset><legend>Features</legend>
                <div class="simple-grid" id="features-list">
                    <div class="grid-header">Feature</div><div class="grid-header">Effect</div>
                    <!-- Feature rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Disadvantages</legend>
                <div class="single-column-grid" id="disadvantages-list">
                    <!-- Disadvantage rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Augmentations</legend>
                <div class="simple-grid" id="augmentations-list">
                    <div class="grid-header">Augmentation</div><div class="grid-header">Effect</div>
                    <!-- Augmentation rows will be populated -->
                </div>
            </fieldset>
             <fieldset><legend>Other Traits</legend>
                <div class="single-column-grid" id="other-traits-list">
                    <!-- Dynamic rows -->
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="metafocus-section">
            <fieldset><legend>Metafocus</legend>
                 <div class="skill-group" id="metafocus-skills-list">
                     <!-- Metafocus skills will be populated here -->
                 </div>
                 <hr>
                 <h5 class="skill-subcategory-header" style="text-align:center; margin-top: 1rem;">Invocations</h5>
                 <div class="simple-grid" id="invocations-list">
                     <div class="grid-header">Invocation</div><div class="grid-header">Level</div>
                 </div>
                 <hr>
                 <h5 class="skill-subcategory-header" style="text-align:center; margin-top: 1rem;">Special Abilities</h5>
                 <div id="special-abilities-list">
                 </div>
            </fieldset>
        </section>


        <section class="main-section" id="folio-3">
             <fieldset><legend>Gear</legend>
                <div class="single-column-grid" id="gear-list">
                     <div class="grid-header">Gear</div>
                </div>
            </fieldset>
            <fieldset><legend>Mecha</legend>
                <div class="single-column-grid" id="mecha-list">
                     <div class="grid-header">Mecha</div>
                </div>
            </fieldset>
            <fieldset><legend>Miscellaneous</legend>
                 <div class="single-column-grid" id="miscellaneous-list">
                     <div class="grid-header">Item</div>
                </div>
            </fieldset>
        </section>

        <section class="main-section" id="folio-4">
             <fieldset><legend>Notes</legend>
                <div class="single-column-grid" id="notes-list">
                    <!-- Notes rows will be populated -->
                </div>
            </fieldset>
        </section>

    </form>
    
    <footer class="creator-credit">
        WOLFE.BT@TANGENTLLC
    </footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Character sheet script loaded. ðŸš€");

        const sheet = document.querySelector('.character-sheet');
        const savePdfBtn = document.getElementById('save-pdf-btn');
        const saveMdBtn = document.getElementById('save-md-btn');

        // --- DATA & SETUP ---

        const attributeOptions = [
            { value: 'attr-strength', text: 'Strength' },
            { value: 'attr-agility', text: 'Agility' },
            { value: 'attr-constitution', text: 'Constitution' },
            { value: 'attr-intellect', text: 'Intellect' },
            { value: 'attr-wisdom', text: 'Wisdom' },
            { value: 'attr-charisma', text: 'Charisma' },
        ];

        const mentalSkillData = {
            "Mental": {
                "skills": ["Alertness"],
                "subcategories": {
                    "Knowledge": ["Academics", "Appraisal", "Computers", "Culture", "History", "Investigation", "Language", "Medicine", "Nature", "Navigation", "Nobility", "Physics", "Religion", "Science", "Survival", "Tactics", "Technology"],
                    "Vocation": ["Administrator", "Alchemist", "Ambassador", "Architect", "Archivist", "Armorer", "Artist", "Artificer", "Broker", "Celebrity", "Constable", "Courtesan", "Culinarian", "Demolitionist", "Electrician", "Engineer", "Groundskeeper", "Handler", "Laborer", "Mechanic", "Researcher", "Salvager", "Soldier", "Tailor", "Transporter", "Weaponsmith"]
                }
            }
        };

        const otherSkillData = {
            "Physical": {
                "skills": ["Acrobatics", "Athletics", "Piloting", "Stealth"]
            },
            "Social": {
                "subcategories": {
                    "Manipulation": ["Insight", "Bluff", "Diplomacy", "Intimidate", "Streetwise"],
                    "Expression": ["Acting", "Comedy", "Dancing", "Disguise", "Keyboard", "Legerdemain", "Oratory", "Percussion", "Singing", "String", "Style", "Wind"]
                }
            },
            "Combat": {
                "subcategories": {
                    "Archaic": ["Defense", "Melee", "Ranged", "Unarmed"],
                    "Modern": ["Ballistic", "Heavy Weapons"],
                    "Advanced": ["Energy", "Heavy Energy"]
                }
            }
        };
        
        const metafocusData = {
            "Attune": [],
            "Dimension": ["Summoning", "Teleport"],
            "Energy": ["Elemental", "Force"],
            "Entropy": ["Chaos", "Order"],
            "Illusion": ["Phantasmal", "Shadow"],
            "Matter": ["Enhancement", "Transmutation"],
            "Mental": ["Projection", "Sense"]
        };

        function createSkillRow(skillName, skillId) {
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.dataset.skillId = skillId;
            let optionsHtml = '<option value="">--</option>';
            attributeOptions.forEach(opt => {
                optionsHtml += `<option value="${opt.value}">${opt.text}</option>`;
            });
            row.innerHTML = `
                <label for="skill-${skillId}-rank">${skillName}</label>
                <input type="number" id="skill-${skillId}-rank" class="skill-rank" placeholder="0">
                <select id="skill-${skillId}-base" class="skill-base-select">${optionsHtml}</select>
                <input type="number" id="skill-${skillId}-mod" class="skill-mod" placeholder="0">
                <input type="number" id="skill-${skillId}-total" class="skill-total" readonly>
            `;
            return row;
        }

        function createEditableSkillRow(skillId) {
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.dataset.skillId = skillId;
            row.dataset.dynamicRow = "true";
            let optionsHtml = '<option value="">--</option>';
            attributeOptions.forEach(opt => {
                optionsHtml += `<option value="${opt.value}">${opt.text}</option>`;
            });
            row.innerHTML = `
                <input type="text" id="skill-${skillId}-name" class="skill-name-input" placeholder="Enter ability name..." data-dynamic-row="true">
                <input type="number" id="skill-${skillId}-rank" class="skill-rank" placeholder="0" data-dynamic-row="true">
                <select id="skill-${skillId}-base" class="skill-base-select" data-dynamic-row="true">${optionsHtml}</select>
                <input type="number" id="skill-${skillId}-mod" class="skill-mod" placeholder="0" data-dynamic-row="true">
                <input type="number" id="skill-${skillId}-total" class="skill-total" readonly>
            `;
            return row;
        }
        
        function populateSkillContainer(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = ''; 

            for (const groupName in data) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'skill-group';
                const header = document.createElement('h4');
                header.className = 'skill-group-header';
                header.textContent = groupName.trim();
                groupDiv.appendChild(header);
                const headerRow = document.createElement('div');
                headerRow.className = 'skill-row header';
                headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
                groupDiv.appendChild(headerRow);
                const groupData = data[groupName];
                if (groupData.skills) {
                    groupData.skills.forEach(skillName => {
                        const skillId = `${groupName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                        groupDiv.appendChild(createSkillRow(skillName, skillId));
                    });
                }
                if (groupData.subcategories) {
                    for (const subcatName in groupData.subcategories) {
                        const subcatHeader = document.createElement('h5');
                        subcatHeader.className = 'skill-subcategory-header';
                        subcatHeader.textContent = subcatName;
                        groupDiv.appendChild(subcatHeader);
                        groupData.subcategories[subcatName].forEach(skillName => {
                            const skillId = `${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                            groupDiv.appendChild(createSkillRow(skillName, skillId));
                        });
                    }
                }
                container.appendChild(groupDiv);
            }
        }
        
        function addTraitRow(grid, traitType) {
            const index = grid.querySelectorAll('[data-dynamic-row="true"]').length / 2;
            const traitInput = document.createElement('input');
            traitInput.type = 'text';
            traitInput.id = `trait-${traitType}-trait-${index}`;
            traitInput.dataset.dynamicRow = "true";
            const effectInput = document.createElement('input');
            effectInput.type = 'text';
            effectInput.id = `trait-${traitType}-effect-${index}`;
            effectInput.dataset.dynamicRow = "true";
            grid.appendChild(traitInput);
            grid.appendChild(effectInput);
        }

        function addSimpleGridRow(grid) {
            const index = grid.querySelectorAll('[data-dynamic-row]').length / 2;
            const type = grid.id.split('-')[0];
            const newRow = document.createElement('div');
            newRow.style.display = 'contents';
            newRow.innerHTML = `<input type="text" id="${type}-name-${index}" data-dynamic-row="true"><input type="text" id="${type}-effect-${index}" data-dynamic-row="true">`;
            grid.appendChild(newRow);
        }
         function addSingleColumnRow(grid) {
            const index = grid.querySelectorAll('[data-dynamic-row]').length;
            const type = grid.id.split('-')[0];
            const newRow = document.createElement('div');
            newRow.style.display = 'contents';
            newRow.innerHTML = `<input type="text" id="${type}-name-${index}" data-dynamic-row="true">`;
            grid.appendChild(newRow);
        }
        
        function addSpecialAbilityRow(container) {
            const index = container.querySelectorAll('.skill-row[data-dynamic-row]').length;
            container.appendChild(createEditableSkillRow(`special-${index}`));
        }

        function populateFolio1() {
            addSingleColumnRow(document.getElementById('modifiers-list'));
            addAttackRow();
        }
        
        function populateMetafocus() {
            const container = document.getElementById('metafocus-skills-list');
            const headerRow = document.createElement('div');
            headerRow.className = 'skill-row header';
            headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
            container.appendChild(headerRow);
            
            container.appendChild(createSkillRow("Attune", "metafocus-attune"));

            const columnsDiv = document.createElement('div');
            columnsDiv.className = 'columns-2 equal-width';
            const leftCol = document.createElement('div');
            leftCol.id = 'metafocus-skills-list-left'; 
            leftCol.className = 'skills-column';
            const rightCol = document.createElement('div');
            rightCol.id = 'metafocus-skills-list-right'; 
            rightCol.className = 'skills-column';

            const leftSkills = ["Dimension", "Energy", "Entropy"];
            
            for (const subcatName in metafocusData) {
                if (subcatName === 'Attune' || subcatName === 'skills' || metafocusData[subcatName].length === 0) continue;
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'skill-group';
                
                const targetCol = leftSkills.includes(subcatName) ? leftCol : rightCol;
                const subcatHeader = document.createElement('h5');
                subcatHeader.className = 'skill-subcategory-header';
                subcatHeader.textContent = subcatName;
                groupDiv.appendChild(subcatHeader);
                
                metafocusData[subcatName].forEach(skillName => {
                    const skillId = `metafocus-${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                    groupDiv.appendChild(createSkillRow(skillName, skillId));
                });
                targetCol.appendChild(groupDiv);
            }
            columnsDiv.appendChild(leftCol);
            columnsDiv.appendChild(rightCol);
            container.appendChild(columnsDiv);
        }

        function populateFolio2() {
            const traitsContainerLeft = document.getElementById('traits-list-left');
            const traitsContainerRight = document.getElementById('traits-list-right');

            const createTraitGrid = (traitType) => {
                const traitGrid = document.createElement('div');
                traitGrid.className = 'trait-grid';
                traitGrid.dataset.traitType = traitType.toLowerCase();
                traitGrid.innerHTML = `<h5>${traitType}</h5><div class="grid-header">Trait</div><div class="grid-header">Effect</div>`;
                addTraitRow(traitGrid, traitType.toLowerCase());
                return traitGrid;
            }

            if (!traitsContainerLeft || !traitsContainerRight) return;
            
            ['Species', 'Origin'].forEach(traitType => {
                traitsContainerLeft.appendChild(createTraitGrid(traitType));
            });
            
            ['Occupation', 'Faction'].forEach(traitType => {
                traitsContainerRight.appendChild(createTraitGrid(traitType));
            });

            addSimpleGridRow(document.getElementById('invocations-list'));
            addSimpleGridRow(document.getElementById('augmentations-list'));
            addSimpleGridRow(document.getElementById('features-list'));
            addSingleColumnRow(document.getElementById('other-traits-list'));
            addSingleColumnRow(document.getElementById('disadvantages-list'));
            addSpecialAbilityRow(document.getElementById('special-abilities-list'));
        }
         function populateFolio3() {
            addSingleColumnRow(document.getElementById('mecha-list'));
            addSingleColumnRow(document.getElementById('gear-list'));
            addSingleColumnRow(document.getElementById('miscellaneous-list'));
        }
        
        function populateFolio4() {
            addSingleColumnRow(document.getElementById('notes-list'));
        }

        function addAttackRow() {
            const container = document.getElementById('attack-rows');
            const index = container.querySelectorAll('[data-dynamic-row]').length / 4;
            const row = document.createElement('div');
            row.style.display = 'contents'; 
            row.innerHTML = `<input type="text" aria-label="Attack ${index} Name" class="attack-name" data-dynamic-row="true"><input type="text" aria-label="Attack ${index} Score" class="attack-score" data-dynamic-row="true"><input type="text" aria-label="Attack ${index} Damage" class="attack-damage" data-dynamic-row="true"><input type="text" aria-label="Attack ${index} Notes" class="attack-notes" data-dynamic-row="true">`;
            container.appendChild(row);
        }

        const calculateSkillTotal = (skillRow) => {
            const rank = parseInt(skillRow.querySelector('.skill-rank')?.value) || 0;
            const mod = parseInt(skillRow.querySelector('.skill-mod')?.value) || 0;
            const totalInput = skillRow.querySelector('.skill-total');
            const selectElement = skillRow.querySelector('.skill-base-select');
            let baseValue = 0;
            if (selectElement) {
                const selectedAttributeId = selectElement.value;
                if (selectedAttributeId) {
                    const attributeInput = document.getElementById(selectedAttributeId);
                    if (attributeInput) {
                        baseValue = parseInt(attributeInput.value) || 0;
                    }
                }
            }
            if (totalInput) {
                totalInput.value = rank + baseValue + mod;
            }
        };

        function handleDynamicRowCreation(event) {
            const target = event.target;
            if (!target.dataset.dynamicRow) return;

            const traitGrid = target.closest('.trait-grid');
            if (traitGrid) {
                const inputs = Array.from(traitGrid.querySelectorAll('[data-dynamic-row]'));
                if (inputs.indexOf(target) >= inputs.length - 2) {
                    addTraitRow(traitGrid, traitGrid.dataset.traitType);
                }
                return;
            }

            const simpleGrid = target.closest('.simple-grid');
            if(simpleGrid) {
                const inputs = Array.from(simpleGrid.querySelectorAll('[data-dynamic-row]'));
                if (inputs.indexOf(target) >= inputs.length - 2) {
                    addSimpleGridRow(simpleGrid);
                }
                return;
            }

            const singleGrid = target.closest('.single-column-grid');
            if(singleGrid) {
                const inputs = Array.from(singleGrid.querySelectorAll('[data-dynamic-row]'));
                if (target === inputs[inputs.length - 1]) {
                    addSingleColumnRow(singleGrid);
                }
                return;
            }

            const specialList = target.closest('#special-abilities-list');
            if(specialList) {
                const inputs = Array.from(specialList.querySelectorAll('[data-dynamic-row]'));
                if(inputs.indexOf(target) >= inputs.length - 5) {
                    addSpecialAbilityRow(specialList);
                }
                return;
            }
            
            const attackGrid = target.closest('#attack-rows');
            if(attackGrid) {
                const inputs = Array.from(attackGrid.querySelectorAll('[data-dynamic-row]'));
                if(inputs.indexOf(target) >= inputs.length - 4) {
                    addAttackRow();
                }
            }
        }

        sheet.addEventListener('input', (event) => {
            if (event.target.matches('.skill-rank, .skill-mod, .attribute-input')) {
                const skillRow = event.target.closest('.skill-row');
                if (skillRow) {
                    calculateSkillTotal(skillRow);
                }
                if (event.target.matches('.attribute-input')) {
                    const changedAttributeId = event.target.id;
                    document.querySelectorAll('.skill-base-select').forEach(select => {
                        if (select.value === changedAttributeId) {
                            calculateSkillTotal(select.closest('.skill-row'));
                        }
                    });
                }
            }
            handleDynamicRowCreation(event);
        });

        sheet.addEventListener('change', (event) => {
            if (event.target.matches('.skill-base-select')) {
                calculateSkillTotal(event.target.closest('.skill-row'));
            }
        });

        // --- PDF EXPORT FUNCTIONS ---
        const getInputValue = (id) => document.getElementById(id)?.value || ' ';
        
        const saveAsPdf = () => {
            const charName = getInputValue('char-name').trim();

            // *** NEW *** Function to get Character Information
            const getBioBlock = () => {
                const body = [
                    [{text: 'Name:', style: 'label'}, getInputValue('char-name'), {text: 'Concept:', style: 'label'}, getInputValue('char-concept')],
                    [{text: 'Species:', style: 'label'}, getInputValue('char-species'), {text: 'Occupation:', style: 'label'}, getInputValue('char-occu')],
                    [{text: 'Origin:', style: 'label'}, getInputValue('char-origin'), {text: 'Faction:', style: 'label'}, getInputValue('char-faction')],
                    [{text: 'Age:', style: 'label'}, getInputValue('char-age'), {text: 'Gender:', style: 'label'}, getInputValue('char-gender')],
                    [{text: 'Height:', style: 'label'}, getInputValue('char-height'), {text: 'Weight:', style: 'label'}, getInputValue('char-weight')],
                    [{text: 'Description / Style:', style: 'label', colSpan: 4, margin: [0, 5, 0, 2]}, {}, {}, {}],
                    [{text: getInputValue('char-style'), colSpan: 4, style: 'textarea'}, {}, {}, {}],
                    [{text: 'Personality / Motive:', style: 'label', colSpan: 4, margin: [0, 5, 0, 2]}, {}, {}, {}],
                    [{text: getInputValue('char-motive'), colSpan: 4, style: 'textarea'}, {}, {}, {}]
                ];
                return { table: { widths: ['auto', '*', 'auto', '*'], body: body }, layout: 'noBorders', marginBottom: 10 };
            };
            
            // *** NEW *** Function to get Primary Attributes
            const getAttributesBlock = () => {
                const body = [
                    [{text: 'Primary Attributes', style: 'h3', colSpan: 4, alignment: 'left', border: [false, false, false, true], marginBottom: 5}, {}, {}, {}],
                    [{text: 'Strength', style:'attrLabel'}, getInputValue('attr-strength'), {text: 'Intellect', style:'attrLabel'}, getInputValue('attr-intellect')],
                    [{text: 'Might', style:'subLabel'}, getInputValue('attr-might'), {text: 'Logic', style:'subLabel'}, getInputValue('attr-logic')],
                    [{text: 'Agility', style:'attrLabel'}, getInputValue('attr-agility'), {text: 'Wisdom', style:'attrLabel'}, getInputValue('attr-wisdom')],
                    [{text: 'Reflex', style:'subLabel'}, getInputValue('attr-reflex'), {text: 'Will', style:'subLabel'}, getInputValue('attr-will')],
                    [{text: 'Constitution', style:'attrLabel'}, getInputValue('attr-constitution'), {text: 'Charisma', style:'attrLabel'}, getInputValue('attr-charisma')],
                    [{text: 'Fortitude', style:'subLabel'}, getInputValue('attr-fortitude'), {text: 'Etiquette', style:'subLabel'}, getInputValue('attr-etiquette')]
                ];
                return { table: { widths: ['*', 'auto', '*', 'auto'], body: body }, layout: 'noBorders', marginBottom: 10 };
            };

            // *** NEW *** Functions for other stats
            const getCoreStatsBlock = () => {
                const body = [
                    [{text: 'Core Stats', style: 'h3', colSpan: 2, alignment: 'left', border: [false, false, false, true], marginBottom: 5}, {}],
                    [{text: 'Health:', style: 'label'}, getInputValue('health')],
                    [{text: 'Vitality:', style: 'label'}, getInputValue('vitality')],
                    [{text: 'Initiative:', style: 'label'}, getInputValue('initiative')]
                ];
                return { table: { widths: ['*', 'auto'], body: body }, layout: 'noBorders', marginBottom: 10 };
            };

            const getRatingsBlock = () => {
                const body = [
                    [{text: 'Ratings', style: 'h3', colSpan: 2, alignment: 'left', border: [false, false, false, true], marginBottom: 5}, {}],
                    [{text: 'Karma:', style: 'label'}, getInputValue('karma')],
                    [{text: 'Plot Points:', style: 'label'}, getInputValue('plot-points')],
                    [{text: 'Tech Level:', style: 'label'}, getInputValue('tech-level')],
                    [{text: 'Wealth:', style: 'label'}, getInputValue('wealth')]
                ];
                return { table: { widths: ['*', 'auto'], body: body }, layout: 'noBorders', marginBottom: 10 };
            };

            const getPdfSkillTables = (containerId) => {
                const tables = [];
                const container = document.getElementById(containerId);
                if (!container) return tables;

                container.querySelectorAll('.skill-group').forEach(group => {
                    const body = [];
                    const groupName = group.querySelector('.skill-group-header, .skill-subcategory-header').textContent;
                    body.push([{ text: groupName.trim(), colSpan: 5, style: 'groupHeader'}, {}, {}, {}, {}]);
                    
                    group.querySelectorAll('.skill-row[data-skill-id], .skill-subcategory-header').forEach(element => {
                        if (element.classList.contains('skill-subcategory-header') && group.querySelector('.skill-group-header')) {
                            body.push([{text: element.textContent, colSpan: 5, style: 'subgroupHeader'}, {}, {}, {}, {}]);
                        } else if (element.classList.contains('skill-row') && element.dataset.skillId) {
                            const label = (element.querySelector('.skill-name-input') || element.querySelector('label')).value || (element.querySelector('.skill-name-input') || element.querySelector('label')).textContent;
                            const rank = getInputValue(`skill-${element.dataset.skillId}-rank`);
                            const baseSelect = element.querySelector('.skill-base-select');
                            const base = baseSelect.options[baseSelect.selectedIndex]?.text || ' ';
                            const mod = getInputValue(`skill-${element.dataset.skillId}-mod`);
                            const total = getInputValue(`skill-${element.dataset.skillId}-total`);
                            body.push([label, rank || ' ', base || ' ', mod || ' ', {text: total || ' ', bold: true}]);
                        }
                    });
                    
                    tables.push({ table: { widths: ['*', 'auto', 'auto', 'auto', 'auto'], body: body, dontBreakRows: true }, layout: 'lightHorizontalLines', marginBottom: 10 });
                });
                return tables;
            };
            
            const getSimpleGridBody = (containerId, headers) => {
                const body = [headers.map(h => ({text: h, style: 'tableHeader'}))];
                const container = document.getElementById(containerId);
                if (!container) return body;

                const inputs = container.querySelectorAll('input[type=text], input[type=number]');
                const numCols = headers.length;
                const contentRows = [];

                for (let i = 0; i < inputs.length; i += numCols) {
                    const row = [];
                    let hasContent = false;
                    for (let j = 0; j < numCols; j++) {
                        const value = inputs[i + j]?.value || ' ';
                        if (value) hasContent = true;
                        row.push(value);
                    }
                    if (hasContent) { contentRows.push(row); }
                }
                if (contentRows.length > 0) {
                    contentRows.forEach(row => body.push(row));
                } else {
                    body.push(Array(numCols).fill(' '));
                }
                return body;
            };

            const getSingleColumnBody = (containerId, header) => {
                const body = [[{text: header, style: 'tableHeader'}]];
                const container = document.getElementById(containerId);
                if (!container) return body;
                const inputs = container.querySelectorAll('input[type=text]');
                const contentRows = [];
                
                inputs.forEach(input => {
                    if (input.value.trim()) { contentRows.push([input.value]); }
                });
                if (contentRows.length > 0) {
                    contentRows.forEach(row => body.push(row));
                } else {
                     body.push([' ']); // Add an empty row if no content
                }
                return body;
            }
            
            const getAttackTableBody = () => getSimpleGridBody('attack-rows', ['Attack', 'Score', 'Damage', 'Notes']);
            const getInvocationsBody = () => getSimpleGridBody('invocations-list', ['Invocation', 'Level']);
            const getAugmentationsBody = () => getSimpleGridBody('augmentations-list', ['Augmentation', 'Effect']);
            const getFeaturesBody = () => getSimpleGridBody('features-list', ['Feature', 'Effect']);

            const getArmorTableBody = () => {
                const body = [[{ text: 'Location', style: 'tableHeader' }, { text: 'Total DR', style: 'tableHeader' }, { text: 'Notes', style: 'tableHeader' }]];
                document.querySelectorAll('#armor-rows > label').forEach(label => {
                    const location = label.textContent;
                    const dr = getInputValue(`${label.htmlFor}-dr`);
                    const notes = getInputValue(`${label.htmlFor}-notes`);
                    body.push([location, dr, notes]);
                });
                return body;
            };

            const getTraitColumnStack = (traitTypes) => {
                const stack = [];
                traitTypes.forEach(traitType => {
                    const body = [];
                    const typeLowerCase = traitType.toLowerCase();
                    body.push([{text: traitType, style: 'h3', colSpan: 2, alignment: 'left', border: [false, false, false, true]}, {}]);
                    
                    const contentRows = [];
                    const traitGrid = document.querySelector(`.trait-grid[data-trait-type="${typeLowerCase}"]`);
                    if(traitGrid) {
                        const inputs = traitGrid.querySelectorAll('input[type=text]');
                        for (let i = 0; i < inputs.length; i += 2) {
                            const traitVal = inputs[i].value;
                            const effectVal = inputs[i+1].value;
                            if (traitVal.trim() || effectVal.trim()) { contentRows.push([traitVal, effectVal]); }
                        }
                    }
                    if(contentRows.length > 0){
                        contentRows.forEach(row => body.push(row));
                    } else {
                        body.push([' ',' ']);
                    }

                    stack.push({ table: { widths:['35%', '65%'], body: body }, layout: 'noBorders', marginBottom: 10 });
                });
                return stack;
            };

            // *** NEW: Revised Document Definition for better layout ***
            const docDefinition = {
                pageSize: 'LETTER',
                pageMargins: [ 25, 40, 25, 40 ],
                content: [
                    // Page 1: Bio, Attributes, Core Stats, Combat
                    { text: 'TANGENT SFF RPG', style: 'h1', alignment: 'center', margin: [0, 0, 0, 15] },
                    getBioBlock(),
                    {
                        columns: [
                            { width: '60%', stack: [ getAttributesBlock() ] },
                            { width: '40%', stack: [ getCoreStatsBlock(), getRatingsBlock() ] }
                        ],
                        columnGap: 20
                    },
                    { text: 'Combat', style: 'h2', margin: [0, 15, 0, 5]},
                    { text: 'Attacks', style: 'h3', margin: [0, 0, 0, 5]},
                    { table: { widths: ['*', 50, 50, '*'], body: getAttackTableBody() }, layout: 'lightHorizontalLines' },
                    { text: 'Armor', style: 'h3', margin: [0, 10, 0, 5]},
                    { table: { widths: [100, 100, '*'], body: getArmorTableBody() }, layout: 'lightHorizontalLines' },

                    // Page 2: Skills
                    { text: '', pageBreak: 'before' },
                    { text: 'Skills', style: 'h1', alignment: 'center', margin: [0, 0, 0, 15] },
                    {
                        columns: [
                            { width: '50%', stack: getPdfSkillTables('skills-list-left') },
                            { width: '50%', stack: getPdfSkillTables('skills-list-right') }
                        ],
                        columnGap: 10
                    },
                    
                    // Page 3: Traits, Features, Metafocus
                    { text: '', pageBreak: 'before' },
                    { text: 'Traits & Features', style: 'h1', alignment: 'center', margin: [0, 0, 0, 15] },
                     {
                        columns: [
                            { width: '50%', stack: getTraitColumnStack(['Species', 'Origin'])},
                            { width: '50%', stack: getTraitColumnStack(['Occupation', 'Faction'])}
                        ],
                        columnGap: 20
                    },
                    {text: 'Augmentations', style: 'h3', margin: [0, 10, 0, 5]},
                    {table: { widths: ['*', '*'], body: getAugmentationsBody()}, layout:'lightHorizontalLines', marginBottom: 10},
                    {text: 'Features', style: 'h3', margin: [0, 10, 0, 5]},
                    {table: { widths: ['*', '*'], body: getFeaturesBody()}, layout:'lightHorizontalLines', marginBottom: 10},
                    {text: 'Disadvantages', style: 'h3', margin: [0, 10, 0, 5]},
                    {table: { widths: ['*'], body: getSingleColumnBody('disadvantages-list', 'Disadvantage') }, layout:'lightHorizontalLines', marginBottom: 10},
                    
                    // Page 4: Metafocus, Gear, Notes
                    { text: '', pageBreak: 'before' },
                    { text: 'Metafocus', style: 'h1', alignment: 'center', margin: [0, 0, 0, 15] },
                    { stack: getPdfSkillTables('metafocus-skills-list') },

                    {text: 'Gear', style: 'h1', alignment: 'center', margin: [0, 20, 0, 15]},
                    {table: { widths: ['*'], body: getSingleColumnBody('gear-list', 'Gear') }, layout:'lightHorizontalLines', marginBottom: 10},
                    {text: 'Mecha', style: 'h3', margin: [0, 10, 0, 5]},
                    {table: { widths: ['*'], body: getSingleColumnBody('mecha-list', 'Mecha') }, layout:'lightHorizontalLines', marginBottom: 10},
                    {text: 'Notes', style: 'h2', margin: [0, 15, 0, 5]},
                    {table: { widths: ['*'], body: getSingleColumnBody('notes-list', 'Note') }, layout:'lightHorizontalLines', marginBottom: 10}
                ],
                footer: function(currentPage, pageCount) { 
                    return { text: 'WOLFE.BT@TANGENTLLC - Page ' + currentPage.toString() + ' of ' + pageCount, alignment: 'center', style: 'footer' }; 
                },
                styles: {
                    h1: { font: 'Roboto', fontSize: 22, bold: true },
                    h2: { font: 'Roboto', fontSize: 18, bold: true },
                    h3: { font: 'Roboto', fontSize: 14, bold: true },
                    label: { bold: true, color: '#444444' },
                    subLabel: { bold: false, color: '#666666', margin: [10, 0, 0, 5] },
                    attrLabel: { bold: true, color: '#333333', margin: [0, 5, 0, 2] },
                    textarea: { italics: true, color: '#555555', margin: [0, 0, 0, 5]},
                    tableHeader: { bold: true, fontSize: 11, color: 'black' },
                    groupHeader: { bold: true, fontSize: 12, color: 'white', fillColor: '#333333' },
                    subgroupHeader: { bold: true, italics: true, fillColor: '#DDDDDD' },
                    footer: { fontSize: 8, italics: true, color: '#555555' }
                },
                defaultStyle: { font: 'Roboto', fontSize: 10 }
            };
            
            pdfMake.createPdf(docDefinition).download(`${charName || 'tangent-character'}.pdf`);
        };
        // --- *** NEW MARKDOWN EXPORT FUNCTIONS *** ---
        
        pdfMake.fonts = {
            Roboto: {
                normal: 'Roboto-Regular.ttf',
                bold: 'Roboto-Medium.ttf',
                italics: 'Roboto-Italic.ttf',
                bolditalics: 'Roboto-MediumItalic.ttf'
            }
        };
        const getInputValueMd = (id) => document.getElementById(id)?.value.trim() || '';

        // Helper function to create a Markdown table from an array of arrays
        const createMdTable = (headers, rows) => {
            if (rows.length === 0) return '_(empty)_\n';
            let table = `| ${headers.join(' | ')} |\n`;
            table += `| ${headers.map(() => '---').join(' | ')} |\n`;
            rows.forEach(row => {
                const sanitizedRow = row.map(cell => (cell || '').replace(/\|/g, '\\|'));
                table += `| ${sanitizedRow.join(' | ')} |\n`;
            });
            return table;
        };

        const getSkillsMarkdown = (containerId) => {
            let text = '';
            const container = document.getElementById(containerId);
            if (!container) return '';

            container.querySelectorAll('.skill-group').forEach(group => {
                const groupName = group.querySelector('.skill-group-header, .skill-subcategory-header').textContent;
                text += `### ${groupName.trim()}\n`;

                const headers = ['Skill', 'Rank', 'Base', 'Mod', 'Total'];
                const rows = [];

                group.querySelectorAll('.skill-row[data-skill-id], .skill-subcategory-header').forEach(element => {
                    if (element.classList.contains('skill-subcategory-header') && group.querySelector('.skill-group-header')) {
                        // This case is handled by starting a new table for each subcategory if needed.
                        // For simplicity, we'll group them under the main header.
                    } else if (element.classList.contains('skill-row') && element.dataset.skillId) {
                        const label = (element.querySelector('.skill-name-input') || element.querySelector('label')).value || (element.querySelector('.skill-name-input') || element.querySelector('label')).textContent;
                        const rank = getInputValueMd(`skill-${element.dataset.skillId}-rank`);
                        const baseSelect = element.querySelector('.skill-base-select');
                        const base = baseSelect.options[baseSelect.selectedIndex]?.text || '';
                        const mod = getInputValueMd(`skill-${element.dataset.skillId}-mod`);
                        const total = getInputValueMd(`skill-${element.dataset.skillId}-total`);
                        if (label || rank || base || mod || total) {
                            rows.push([label, rank, base.replace('--',''), mod, `**${total}**`]);
                        }
                    }
                });
                 text += createMdTable(headers, rows) + '\n';
            });
            return text;
        };

        const getSimpleGridMarkdown = (containerId, headers) => {
            const rows = [];
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('input[type=text], input[type=number]');
            const numCols = headers.length;

            for (let i = 0; i < inputs.length; i += numCols) {
                const rowData = [];
                let hasContent = false;
                for (let j = 0; j < numCols; j++) {
                    const value = inputs[i+j]?.value.trim() || '';
                    if (value) hasContent = true;
                    rowData.push(value);
                }
                if (hasContent) { rows.push(rowData); }
            }
            return createMdTable(headers, rows);
        };

        const getSingleColumnMarkdown = (containerId, header) => {
            let text = `### ${header}\n`;
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('input[type=text]');
            let hasContent = false;
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    text += `* ${value}\n`;
                    hasContent = true;
                }
            });
            return hasContent ? text + '\n' : `${text}* _(empty)_\n\n`;
        };
        
        const saveAsMarkdown = () => {
            const charName = getInputValueMd('char-name');
            let mdString = `# ${charName || 'Tangent Character'}\n\n`;

            // Character Info
            mdString += `## Character Information\n`;
            mdString += `* **Concept:** ${getInputValueMd('char-concept')}\n`;
            mdString += `* **Species:** ${getInputValueMd('char-species')}\n`;
            mdString += `* **Occupation:** ${getInputValueMd('char-occu')}\n`;
            mdString += `* **Origin:** ${getInputValueMd('char-origin')}\n`;
            mdString += `* **Faction:** ${getInputValueMd('char-faction')}\n`;
            mdString += `* **Age:** ${getInputValueMd('char-age')}\n`;
            mdString += `* **Gender:** ${getInputValueMd('char-gender')}\n`;
            mdString += `* **Height:** ${getInputValueMd('char-height')}\n`;
            mdString += `* **Weight:** ${getInputValueMd('char-weight')}\n\n`;
            mdString += `### Description / Style\n${getInputValueMd('char-style') || '_(empty)_'}\n\n`;
            mdString += `### Personality / Motive\n${getInputValueMd('char-motive') || '_(empty)_'}\n\n`;

            // Attributes & Stats
            mdString += `## Attributes & Stats\n`;
            mdString += `| Attribute | Score | Derived | Score | | Attribute | Score | Derived | Score |\n`;
            mdString += `| :--- | :---: | :--- | :---: | :---: | :--- | :---: | :--- | :---: |\n`;
            mdString += `| **Strength** | ${getInputValueMd('attr-strength')} | Might | ${getInputValueMd('attr-might')} | | **Intellect** | ${getInputValueMd('attr-intellect')} | Logic | ${getInputValueMd('attr-logic')} |\n`;
            mdString += `| **Agility** | ${getInputValueMd('attr-agility')} | Reflex | ${getInputValueMd('attr-reflex')} | | **Wisdom** | ${getInputValueMd('attr-wisdom')} | Will | ${getInputValueMd('attr-will')} |\n`;
            mdString += `| **Constitution** | ${getInputValueMd('attr-constitution')} | Fortitude | ${getInputValueMd('attr-fortitude')} | | **Charisma** | ${getInputValueMd('attr-charisma')} | Etiquette | ${getInputValueMd('attr-etiquette')} |\n\n`;
            
            mdString += `| Core Stat | Value | | Rating | Value |\n`;
            mdString += `| :--- | :---: | :---: |:--- | :---: |\n`;
            mdString += `| Health | ${getInputValueMd('health')} | | Karma | ${getInputValueMd('karma')} |\n`;
            mdString += `| Vitality | ${getInputValueMd('vitality')} | | Plot Points | ${getInputValueMd('plot-points')} |\n`;
            mdString += `| Initiative | ${getInputValueMd('initiative')} | | Tech Level | ${getInputValueMd('tech-level')} |\n`;
            mdString += `| | | | Wealth | ${getInputValueMd('wealth')} |\n\n`;

            // Combat
            mdString += `## Combat\n### Attacks\n`;
            mdString += getSimpleGridMarkdown('attack-rows', ['Attack', 'Score', 'Damage', 'Notes']);
            mdString += `\n### Armor\n`;
            const armorRows = [];
            document.querySelectorAll('#armor-rows > label').forEach(label => {
                const location = label.textContent;
                const dr = getInputValueMd(`${label.htmlFor}-dr`);
                const notes = getInputValueMd(`${label.htmlFor}-notes`);
                if (dr || notes) armorRows.push([location, dr, notes]);
            });
            mdString += createMdTable(['Location', 'Total DR', 'Notes'], armorRows);

            // Skills
            mdString += `\n## Skills\n`;
            mdString += getSkillsMarkdown('skills-list-left');
            mdString += getSkillsMarkdown('skills-list-right');

            // Traits & Features
            mdString += `\n## Traits & Features\n`;
            document.querySelectorAll('#traits-list-left .trait-grid, #traits-list-right .trait-grid').forEach(grid => {
                const title = grid.querySelector('h5').textContent;
                mdString += `### ${title} Traits\n`;
                mdString += getSimpleGridMarkdown(grid.id, ['Trait', 'Effect']);
            });
            mdString += getSingleColumnMarkdown('other-traits-list', 'Other Traits');
            mdString += getSimpleGridMarkdown('augmentations-list', ['Augmentation', 'Effect']);
            mdString += getSimpleGridMarkdown('features-list', ['Feature', 'Effect']);
            mdString += getSingleColumnMarkdown('disadvantages-list', 'Disadvantages');
            
            // Metafocus
            mdString += `\n## Metafocus\n`;
            mdString += getSkillsMarkdown('metafocus-skills-list');
            mdString += `### Invocations\n`;
            mdString += getSimpleGridMarkdown('invocations-list', ['Invocation', 'Level']);
            
            // Gear & Notes
            mdString += `\n## Equipment & Notes\n`;
            mdString += getSingleColumnMarkdown('gear-list', 'Gear');
            mdString += getSingleColumnMarkdown('mecha-list', 'Mecha');
            mdString += getSingleColumnMarkdown('miscellaneous-list', 'Miscellaneous');
            mdString += getSingleColumnMarkdown('notes-list', 'Notes');

            // Download Logic
            const blob = new Blob([mdString], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${charName.replace(/\s/g, '_') || 'tangent-character'}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        
        // Event Listeners
        savePdfBtn.addEventListener('click', saveAsPdf);
        saveMdBtn.addEventListener('click', saveAsMarkdown);

        // Initial Population
        populateSkillContainer('skills-list-left', mentalSkillData);
        populateSkillContainer('skills-list-right', otherSkillData);
        populateMetafocus();
        populateFolio1();
        populateFolio2();
        populateFolio3();
        populateFolio4();

        // Calculate all skill totals on load in case attributes have default values
        document.querySelectorAll('.skill-row').forEach(calculateSkillTotal);
    });
</script>

</body>
</html>
